---
title: "Estimating the rate and time of gene flow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Estimating the rate and time of gene flow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
#devtools::install(upgrade=FALSE)

slendr_present <- slendr::check_dependencies(python = TRUE, slim = TRUE, quit = FALSE)

knitr::opts_chunk$set(
  collapse = FALSE,
  comment = "#>",
  fig.align = "center",
  fig.width = 8,
  fig.height = 5,
  dpi = 80,
  eval = slendr_present
)

true_tracts_path <- here::here("inst/examples/tracts_truth.rds")
data_path <- here::here("inst/examples/tracts_data.rds")

devtools::load_all()
```

```{r, echo=FALSE, message=FALSE}
library(ggplot2)
library(dplyr)

library(demografr)
library(slendr)

init_env()

SEED <- 42
set.seed(SEED)
```

Suppress annoying pandas warning triggered by the tspop package:

```{r}
warnings <- reticulate::import("warnings")
warnings$simplefilter("ignore")
```

```{r, eval=!file.exists(true_tracts_path)}
anc <- population("ancestors", N = 10000, time = 1000000, remove = 649000)
afr <- population("Africans", parent = anc, N = 10000, time = 650000)
nea <- population("Neanderthals", parent = anc, N = 2000, time = 650000)
eur <- population("Europeans", parent = afr, N = 5000, time = 60000)

gf <- gene_flow(from = nea, to = eur, rate = 0.03, start = 55000, end = 55000 - 30)

true_model <- compile_model(
  populations = list(anc, afr, nea, eur), gene_flow = gf,
  generation_time = 30
)

samples <- schedule_sampling(true_model, times = 0, list(eur, 100))

plot_model(true_model, proportions = TRUE,
           order = c("Africans", "Europeans", "ancestors", "Neanderthals"))

true_ts <- msprime(true_model, sequence_length = 200e6, recombination_rate = 1e-8, samples = samples)

true_tracts <- ts_tracts(true_ts, census = 55000, quiet = TRUE)

saveRDS(true_tracts, true_tracts_path)
```

```{r, eval=file.exists(true_tracts_path), echo=FALSE}
true_tracts <- readRDS(true_tracts_path)
```

```{r}
# count tracts in twenty length bins
n <- 20
bins <- cut(true_tracts$length, breaks = n)
counts <- as.vector(table(bins))

# return proportions of tracts in each bin
true_bins <- data.frame(bin = as.character(1:n), prop = counts / sum(counts))

ggplot(true_bins, aes(x = as.integer(bin), y = prop)) + geom_bar(stat = "identity")

observed_bins <- true_bins
```

```{r}
observed_bins
```

```{r}
observed <- list(tract_bins = observed_bins)
```

## Define ABC pipeline components

## Model function

```{r}
model <- function(admixture_time, admixture_rate) {
  generation_time <- 30

  anc <- population("ancestors", N = 10000, time = 1000000, remove = 649000)
  afr <- population("Africans", parent = anc, N = 10000, time = 650000)
  nea <- population("Neanderthals", parent = anc, N = 2000, time = 650000)
  eur <- population("Europeans", parent = afr, N = 5000, time = 60000)

  gf <- gene_flow(
    from = nea, to = eur,
    rate = admixture_rate,    # first model parameter
    start = admixture_time,   # second model parameter
    end = admixture_time - generation_time
  )

  model <- compile_model(
    populations = list(anc, afr, nea, eur), gene_flow = gf,
    generation_time = generation_time
  )
  
  samples <- schedule_sampling(model, times = 0, list(eur, 100))

  return(list(model, samples))
}
```

## Parameter priors

```{r}
priors <- list(
  admixture_time ~ runif(20000, 100000),
  admixture_rate ~ runif(0, 0.3)
)
```

As a sanity check, can we simulate a tree sequence from the model and priors?

```{r}
ts <- simulate_output(model, priors, sequence_length = 10e6, recombination_rate = 1e-8)
```

## Summary function

```{r}
tract_bins <- function(ts) {
  # get the admixture time of the simulated model
  gf_time <- attr(ts, "model")$geneflow$tstart_orig

  # extract tracts of Neanderthal ancestry in Europeans (no need to specify
  # sources and targets because we have only one gene flow in the model)
  tracts <- ts_tracts(ts, census = gf_time, quiet = TRUE)

  # count tracts in 20 length bins
  n <- 20

  # take care of the edge case in which we get no tracts at all -- in such
  if (nrow(tracts) > 0) {
    bins <- cut(tracts$length, breaks = n)
    counts <- as.vector(table(bins))
    prop <- counts / sum(counts)
  } else
    prop <- rep(0, n)

  # return proportions of tracts in each bin
  data.frame(bin = as.character(1:n), prop = prop)
}

functions <- list(tract_bins = tract_bins)
```

Using the simulated tree sequence `ts` above, let's again make sure that our summary function is defined correctly and that it produces a reasonable result:

```{r}
bins <- functions$tract_bins(ts)
bins
```

```{r}
ggplot(bins, aes(x = as.integer(bin), y = prop)) + geom_bar(stat = "identity")
```


## Validating all components

Our simple sanity checks suggest that our ABC model components are defined correctly. However, to be absolutely sure that everything works, let's validate the model using _demografr_'s automated validation function:

```{r}
validate_abc(model, priors, functions, observed)
```


## Run ABC simulations

```{r}
library(future)
plan(multisession, workers = availableCores())
```

```{r}
data <- simulate_abc(model, priors, functions, observed, iterations = 10000,
                     sequence_length = 100e6, recombination_rate = 1e-8)
saveRDS(data, data_path)
```

```{r}
data = readRDS(data_path)
```

```{r}
abc <- run_abc(data, engine = "abc", tol = 0.05, method = "neuralnet")
```

```{r}
plot_posterior(abc, facets = TRUE)
```

```{r}
extract_summary(abc)
```




```{r}
predictions <- predict(abc, samples = 100)
```


```{r, postpred_bins}
plot_prediction(predictions, "tract_bins")
```
