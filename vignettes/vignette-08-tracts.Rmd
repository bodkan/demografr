---
title: "Estimating the rate and time of gene flow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Estimating the rate and time of gene flow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
devtools::install(upgrade=FALSE)

slendr_present <- slendr::check_dependencies(python = TRUE, slim = TRUE, quit = TRUE)

knitr::opts_chunk$set(
  collapse = FALSE,
  comment = "#>",
  fig.align = "center",
  fig.width = 8,
  fig.height = 5,
  dpi = 80,
  eval = slendr_present
)

true_bins_path <- here::here("inst/examples/tracts_true_bins.rds")
true_f4_path <- here::here("inst/examples/tracts_true_f4.rds")

data_path <- here::here("inst/examples/tracts_data.rds")

devtools::load_all()
```

```{r, echo=FALSE, message=FALSE}
library(ggplot2)
library(dplyr)

library(demografr)
library(slendr)

init_env()

SEED <- 42
set.seed(SEED)
```

```{r, eval=!file.exists(true_bins_path)}
anc <- population("ancestors", N = 10000, time = 7e6, remove = 649000)
chimp <- population("Chimpanzees", parent = anc, N = 10000, time = 6e6)
afr <- population("Africans", parent = anc, N = 10000, time = 650000)
nea <- population("Neanderthals", parent = anc, N = 2000, time = 650000)
eur <- population("Europeans", parent = afr, N = 5000, time = 60000)

gf <- gene_flow(from = nea, to = eur, rate = 0.03, start = 57000, end = 53000)

true_model <- compile_model(
  populations = list(anc, chimp, afr, nea, eur), gene_flow = gf,
  generation_time = 30
)

samples <- schedule_sampling(
  true_model, times = 0,
  list(eur, 100), list(afr, 2), list(nea, 1), list(chimp, 1)
)

plot_model(true_model, proportions = TRUE, log = TRUE, samples = samples,
           order = c("Africans", "Europeans", "ancestors", "Neanderthals", "Chimpanzees"))

true_ts <- msprime(true_model, sequence_length = 200e6, recombination_rate = 1e-8, samples = samples) %>%
  ts_mutate(mutation_rate = 1e-8, random_seed = SEED)

true_tracts <- ts_tracts(true_ts, census = 57000, quiet = TRUE)
```

```{r, eval=!file.exists(true_bins_path), echo=FALSE}
# count tracts in twenty length bins
n <- 20
bins <- cut(true_tracts$length, breaks = n)
counts <- as.vector(table(bins))

# return proportions of tracts in each bin
true_bins <- data.frame(length_bin = 1:n, prop = counts / sum(counts))

saveRDS(true_bins, true_bins_path)
```

```{r, eval=!file.exists(true_f4_path), echo=FALSE}
samples <- ts_names(true_ts, split = "pop")

true_f4 <- rbind(
  ts_f4(true_ts, W = "Africans_1", X = samples["Europeans"], Y = "Neanderthals_1", Z = "Chimpanzees_1"),
  ts_f4(true_ts, W = "Africans_1", X = "Africans_2", Y = "Neanderthals_1", Z = "Chimpanzees_1")
)

saveRDS(true_f4, true_f4_path)
```

```{r, eval=file.exists(true_f4_path), echo=FALSE}
observed_f4 <- readRDS(true_f4_path)
```

```{r, eval=file.exists(true_bins_path), echo=FALSE}
observed_bins <- readRDS(true_bins_path)
```

```{r}
ggplot(observed_bins, aes(x = length_bin, y = prop)) + geom_bar(stat = "identity")
```

```{r}
observed_bins
```

```{r}
observed_f4
```

```{r}
observed <- list(tract_bins = observed_bins, f4 = observed_f4)

observed
```

## Define ABC pipeline components

## Model function

```{r}
model <- function(admixture_time, admixture_rate) {
  generation_time <- 30

  anc <- population("ancestors", N = 10000, time = 7e6, remove = 649000)
  chimp <- population("Chimpanzees", parent = anc, N = 10000, time = 6e6)
  afr <- population("Africans", parent = anc, N = 10000, time = 650000)
  nea <- population("Neanderthals", parent = anc, N = 2000, time = 650000)
  eur <- population("Europeans", parent = afr, N = 5000, time = 60000)
  
  gf <- gene_flow(from = nea, to = eur, rate = 0.03, start = 57000, end = 53000)
  
  model <- compile_model(
    populations = list(anc, chimp, afr, nea, eur), gene_flow = gf,
    generation_time = 30, serialize = FALSE
  )
  
  samples <- schedule_sampling(
    model, times = 0,
    list(eur, 100), list(afr, 2), list(nea, 1), list(chimp, 1)
  )

  return(list(model, samples))
}
```

## Parameter priors

```{r}
priors <- list(
  admixture_time ~ runif(20000, 100000),
  admixture_rate ~ runif(0, 0.3)
)
```

As a sanity check, can we simulate a tree sequence from the model and priors?

```{r}
ts <- simulate_ts(model, priors, sequence_length = 10e6, recombination_rate = 1e-8, mutation_rate = 1e-8)
```

## Summary function

```{r}
tract_bins <- function(ts) {
  # get the admixture time of the simulated model
  gf_time <- attr(ts, "model")$geneflow$tstart_orig

  # extract tracts of Neanderthal ancestry in Europeans (no need to specify
  # sources and targets because we have only one gene flow in the model)
  tracts <- ts_tracts(ts, census = gf_time, quiet = TRUE)

  # count tracts in 20 length bins
  n <- 20

  # take care of the edge case in which we get no tracts at all -- in such
  if (nrow(tracts) > 0) {
    bins <- cut(tracts$length, breaks = n)
    counts <- as.vector(table(bins))
    prop <- counts / sum(counts)
  } else
    prop <- rep(0, n)

  # return proportions of tracts in each bin
  data.frame(length_bin = 1:n, prop = prop)
}

f4 <- function(ts) {
  samples <- ts_names(ts, split = "pop")

  rbind(
    ts_f4(ts, W = "Africans_1", X = samples["Europeans"], Y = "Neanderthals_1", Z = "Chimpanzees_1"),
    ts_f4(ts, W = "Africans_1", X = "Africans_2", Y = "Neanderthals_1", Z = "Chimpanzees_1")
  )
}

functions <- list(tract_bins = tract_bins, f4 = f4)
```

Using the simulated tree sequence `ts` above, let's again make sure that our summary function is defined correctly and that it produces a reasonable result:

```{r}
bins <- functions$tract_bins(ts)

ggplot(bins, aes(x = length_bin, y = prop)) + geom_bar(stat = "identity")
```

```{r}
functions$f4(ts)
```


## Validating all components

Our simple sanity checks suggest that our ABC model components are defined correctly. However, to be absolutely sure that everything works, let's validate the model using _demografr_'s automated validation function:

```{r}
validate_abc(model, priors, functions, observed)
```

## Run ABC simulations

```{r}
# schedule simulations across all CPU cores
library(future)
plan(multisession, workers = availableCores())

# show a progress bar in the console
library(progressr)
handlers(global = TRUE)
```

```{r}
data <- simulate_abc(
  model, priors, functions, observed, iterations = 2000,
  sequence_length = 50e6, recombination_rate = 1e-8, mutation_rate = 1e-8
)
```

```{r, eval=!file.exists(data_path)}
saveRDS(data, data_path)
```

```{r, eval=file.exists(data_path)}
data <- readRDS(data_path)
```

```{r}
abc <- run_abc(data, engine = "abc", tol = 0.05, method = "neuralnet")
```

```{r}
plot_posterior(abc, facets = TRUE)
```

```{r}
extract_summary(abc)
```




```{r}
predictions <- predict(abc, samples = 90)
```


```{r, postpred_bins}
plot_prediction(predictions, "tract_bins")
```

```{r, postpred_f4}
plot_prediction(predictions, "f4", facets = FALSE) +
  ggplot2::geom_vline(xintercept = 0, linetype = 2)
```

```{r}
predictions
```

