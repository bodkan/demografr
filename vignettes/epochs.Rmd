---
title: Meeting notes on modelling "Ne epochs"
output:
  md_document:
    variant: gfm
vignette: >
  %\VignetteIndexEntry{Meeting notes on modelling "Ne epochs"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = FALSE,
  comment = "#>",
  fig.width = 5,
  fig.height = 5,
  dpi = 100
)
```

```{r, echo=FALSE, message=FALSE}
library(demografr)
library(slendr)

init_env()

SEED <- 42
set.seed(SEED)
```

```{r, echo=FALSE}
pop <- population("pop", time = 1, N = 100) %>%
  resize(time = 3000, N = 1000, how = "step") %>%
  resize(time = 6000, N = 5000, how = "step") %>%
  resize(time = 8000, N = 20000, how = "step") %>%
  resize(time = 9000, N = 8000, how = "step")

example_model <- compile_model(pop, generation_time = 1, simulation_length = 10000)
```

```{r, eval=!file.exists(system.file("examples/exp_observed_diversity.tsv", package = "demografr")), echo=FALSE, message=FALSE}
samples <- schedule_sampling(example_model, times = seq(1000, 10000, 1000), list(pop, 50))

ts <- msprime(example_model, sequence_length = 100e6, recombination_rate = 1e-8,
              samples = samples, random_seed = SEED) %>%
  ts_mutate(1e-8, random_seed = SEED)

sample_sets <- ts_samples(ts) %>% split(., .$time)

observed_diversity <- ts_diversity(ts, sample_sets)

write.table(observed_diversity, file = here::here("inst/examples/exp_observed_diversity.tsv"),
            sep = "\t", row.names = FALSE, quote = FALSE)
```

**Imagine the following demographic model:**

```{r, echo=FALSE}
library(ggplot2)
plot_model(example_model) + ggtitle("Ne = 100 --> 1000 --> 5000 --> 20000 --> 2000")
```

With the following "observed" values of nucleotide diversity at different time slices from groups of 50 diploid individuals at each time point:

```{r, echo=FALSE}
observed_diversity <- read.table(system.file("examples/exp_observed_diversity.tsv", package = "demografr"), header = TRUE) %>% dplyr::rename(time = set)
```

```{r}
observed_diversity
```

### How to fit variable $N_e$ with _demografr_ and _slendr_?

#### Encoding epochs manually

The users always have the option to specify Ne epochs like this, manually:

```{r, eval=FALSE}
model <- function(Ne_start, Ne_epoch1, Ne_epoch2, ...) {
  pop <-
    population("pop", time = 1, N = Ne_start) %>%
    resize(N = Ne_epoch1, time = <T_epoch1>, how = "step") %>%
    resize(N = Ne_epoch2, time = <T_epoch2>, how = "step") %>%
    # <more resizes>

  model <- compile_model(pop, generation_time = 1, simulation_length = 10000, direction = "forward")

  model
}
```

With the priors perhaps like this:

```{r, eval=FALSE}
priors <- list(
  Ne_start  ~ runif(1, 30000),
  Ne_epoch1 ~ runif(1, 30000),
  Ne_epoch2 ~ runif(1, 30000),
  # <more resizes>
)
```

**But this seems very cumbersome, arbitrary, and error-prone?**

<!--
Standard setup of the pipeline first:

```{r}
library(demografr)
library(slendr)

# set up the internal tskit/msprime environment
init_env()

# set up parallelization across all CPUs
library(future)
plan(multicore, workers = availableCores())

#--------------------------------------------------------------------------------
# bind data frames with empirical summary statistics into a named list
observed <- list(diversity = observed_diversity)
```
-->

#### New function `resize_epochs()`?

**We have a new function `resize_epochs()` designed to fit variable Ne trajectories:**

```{r}
#--------------------------------------------------------------------------------
# define a model generating function using the slendr interface
# (each of the function parameters correspond to a parameter we want to infer)
model <- function(Ne_start, Ne_epochs) {
  pop <-
    population("pop", time = 1, N = Ne_start) %>%
    resize_epochs(epochs = 9, sizes = Ne_epochs, until = 10000)

  model <- compile_model(pop, generation_time = 1, simulation_length = 10000, direction = "forward")

  model
}
```

This function utilizes the new vectorized prior sampling (see `Ne_epochs[9]` below):

```{r}
#--------------------------------------------------------------------------------
# setup priors for model parameters
priors <- list(
  Ne_start     ~ runif(1, 30000),
  Ne_epochs[9] ~ runif(1, 30000)
)
```

<!--
The rest of the analysis looks exactly the same...

```{r, eval=!file.exists(here::here("inst/examples/exp_data.rds"))}
#--------------------------------------------------------------------------------
# define summary functions to be computed on simulated data (must be of the
# same format as the summary statistics computed on empirical data)
compute_diversity <- function(ts) {
  sample_sets <- ts_samples(ts) %>% split(., .$time)
  ts_diversity(ts, sample_sets)
}

# the summary functions must be also bound to an R list named in the same
# way as the empirical summary statistics
functions <- list(
  diversity = compute_diversity
)

#--------------------------------------------------------------------------------
# validate the individual ABC components for correctness and consistency
validate_abc(model, priors, functions, observed)

#--------------------------------------------------------------------------------
# run ABC simulations
data <- simulate_abc(
  model, priors, functions, observed, iterations = 1000,
  sequence_length = 10e6, recombination_rate = 1e-8, mutation_rate = 1e-8
)

#--------------------------------------------------------------------------------
# infer posterior distributions of parameters using the abc R package
abc <- perform_abc(data, engine = "abc", tol = 0.03, method = "neuralnet")
```

```{r, echo=FALSE, eval=!file.exists(here::here("inst/examples/exp_data.rds"))}
saveRDS(data, here::here("inst/examples/exp_data.rds"))
```

```{r, echo=FALSE, eval=file.exists(here::here("inst/examples/exp_data.rds")), warning=FALSE, message=FALSE, results="hide"}
data <- readRDS(system.file("examples/exp_data.rds", package = "demografr"))
abc <- perform_abc(data, engine = "abc", tol = 0.03, method = "neuralnet")
```
-->
