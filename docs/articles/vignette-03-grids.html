<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Support for grid simulations • demografr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Support for grid simulations">
<meta property="og:description" content="demografr">
<meta property="og:image" content="https://bodkan.net/demografr/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">demografr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question-circle"></span>
     
    Reference
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-book"></span>
     
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/vignette-01-basics.html">A basic ABC analysis</a>
    </li>
    <li>
      <a href="../articles/vignette-02-priors.html">Specifying prior distributions</a>
    </li>
    <li>
      <a href="../articles/vignette-03-grids.html">Support for grid simulations</a>
    </li>
    <li>
      <a href="../articles/vignette-04-parallelization.html">Parallelization options</a>
    </li>
    <li>
      <a href="../articles/vignette-05-custom-engines.html">Custom SLiM or Python simulations</a>
    </li>
    <li>
      <a href="../articles/vignette-06-downstream.html">Cross-validation and model selection</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/bodkan/demografr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://fosstodon.org/bodkan" class="external-link">
    <span class="fa fa-mastodon"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Support for grid simulations</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bodkan/demografr/blob/HEAD/vignettes/vignette-03-grids.Rmd" class="external-link"><code>vignettes/vignette-03-grids.Rmd</code></a></small>
      <div class="hidden name"><code>vignette-03-grids.Rmd</code></div>

    </div>

    
    
<p>⚠️⚠️⚠️</p>
<p><strong>Note:</strong> The <em>demografr</em> R package is still under active development. As a result, its documentation is in a draft stage at best. Apologies for typos, inconsistencies, and other issues.</p>
<p>⚠️⚠️⚠️</p>
<p>Although Approximate Bayesian Computation is arguably the most popular method for simulation-based inference, it’s certainly not the only one. Another useful method for exploring the behavior of statistics under given combination of model parameters, and perhaps even very simple model parameter fitting are grid simulations. Briefly, we define a set of parameters of a model, run simulation replicates for each combination of parameters, computing summary statistics of interest for each replicat, and then—for instance—inspect which parameter combinations lead to the values of summary statistics closes to those we observed in the data, or simply inspect how do different parameter values affect the statistics in general.</p>
<div class="section level2">
<h2 id="example-analysis">Example analysis<a class="anchor" aria-label="anchor" href="#example-analysis"></a>
</h2>
<p>To demonstrate the features of <em>demografr</em> for grid-based simulation inference, let’s try to reproduce (at least qualitatively) the result from Petr <em>et al.</em> (PNAS 2018). Briefly, this paper made an attempt to explain discrepancies between two different ways to estimate the proportion of Neanderthal ancestry in Europe over tens of thousands of years.</p>
<ol style="list-style-type: decimal">
<li>The first statistic (dubbed the “indirect <span class="math inline">\(f_4\)</span>-ratio” statistic) showed the following pattern of Neanderthal ancestry significantly declining over time (figure from <a href="https://www.nature.com/articles/nature17993" class="external-link">Fu _et al., Nature 2016</a>)</li>
</ol>
<p><img src="images/fu_2016.png" style="width:80.0%"></p>
<ol start="2" style="list-style-type: decimal">
<li>An alternative statistic (called “direct <span class="math inline">\(f_4\)</span>-ratio” statistic, shown in the figure below in solid line in contrast to the “indirect <span class="math inline">\(f_4\)</span>-statistic” as dashed line) did not find any significant decline at all as shown in this figure from Petr <em>et al.</em> (PNAS 2018).</li>
</ol>
<p><img src="images/petr_2018a.png" style="width:80.0%"></p>
<p><strong>The question was, why are these two measures of Neanderthal ancestry leading to different conclusions?</strong> Could some violations of their assumptions (such as unnacounted-for gene-flow events between modern human populations) break one of them?</p>
<p>The way the PNAS 2018 study approached the problem was tu run many simulation replicates across a large parameter grid. This required writing custom coalescent simulations, orchestrating running them across the parameter grid, collecting outputs, and computing population genetic statistics (here direct and indirect <span class="math inline">\(f_4\)</span>-ratios)—all in all, a couple of hundred lines of Python, R, and bash.</p>
<p>This vignette shows how to use <em>demografr</em> to perform this kind of analyses in a much more straightforward and reproducible manner, entirely in R.</p>
</div>
<div class="section level2">
<h2 id="grid-simulation-with-demografr">Grid simulation with <em>demografr</em><a class="anchor" aria-label="anchor" href="#grid-simulation-with-demografr"></a>
</h2>
<div class="section level3">
<h3 id="define-a-slendr-model-function-capturing-the-demographic-history">1. Define a <em>slendr</em> model function capturing the demographic history<a class="anchor" aria-label="anchor" href="#define-a-slendr-model-function-capturing-the-demographic-history"></a>
</h3>
<p>As in any standard ABC pipeline using <em>demografr</em>, we leverage the <em>slendr</em> R package to first define a demografic model, encoding it as a simple R function. Again, as with standard ABC, <strong>the arguments of this function correspond to model parameters</strong>. Note that those will come from the parameter grid, not via sampling from priors as with ABC!</p>
<p>In our example, because the research question of interest involved various gene-flow rates between populations in the model, we fix split times and <span class="math inline">\(N_e\)</span> values because they are not that interesting or important for this simple analysis (we ignore the Eurasia to Africa “backflow” for the same reason):</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">rate_ea</span>, <span class="va">rate_aa</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># create populations</span></span>
<span>  <span class="va">chimp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/population.html" class="external-link">population</a></span><span class="op">(</span><span class="st">"chimp"</span>, time <span class="op">=</span> <span class="fl">7e6</span>,   N <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span>
<span>  <span class="va">anc</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/population.html" class="external-link">population</a></span><span class="op">(</span><span class="st">"anc"</span>,   time <span class="op">=</span> <span class="fl">6e6</span>,   N <span class="op">=</span> <span class="fl">10000</span>, parent <span class="op">=</span> <span class="va">chimp</span><span class="op">)</span></span>
<span>  <span class="va">nea</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/population.html" class="external-link">population</a></span><span class="op">(</span><span class="st">"nea"</span>,   time <span class="op">=</span> <span class="fl">600e3</span>, N <span class="op">=</span> <span class="fl">2000</span>,  parent <span class="op">=</span> <span class="va">anc</span><span class="op">)</span></span>
<span>  <span class="va">afr1</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/population.html" class="external-link">population</a></span><span class="op">(</span><span class="st">"afr1"</span>,  time <span class="op">=</span> <span class="fl">600e3</span>, N <span class="op">=</span> <span class="fl">15000</span>, parent <span class="op">=</span> <span class="va">anc</span><span class="op">)</span></span>
<span>  <span class="va">afr2</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/population.html" class="external-link">population</a></span><span class="op">(</span><span class="st">"afr2"</span>,  time <span class="op">=</span> <span class="fl">150e3</span>, N <span class="op">=</span> <span class="fl">15000</span>, parent <span class="op">=</span> <span class="va">afr1</span><span class="op">)</span></span>
<span>  <span class="va">eur</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/population.html" class="external-link">population</a></span><span class="op">(</span><span class="st">"eur"</span>,   time <span class="op">=</span> <span class="fl">75e3</span>,  N <span class="op">=</span> <span class="fl">5000</span>,  parent <span class="op">=</span> <span class="va">afr2</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># define gene-flow events</span></span>
<span>  <span class="va">gf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="co"># back flow from Eurasia into Africa -- one parameter of interest</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/gene_flow.html" class="external-link">gene_flow</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">eur</span>, to <span class="op">=</span> <span class="va">afr1</span>, start <span class="op">=</span> <span class="fl">5e3</span>, end <span class="op">=</span> <span class="fl">0</span>, rate <span class="op">=</span> <span class="va">rate_ea</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/gene_flow.html" class="external-link">gene_flow</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">eur</span>, to <span class="op">=</span> <span class="va">afr2</span>, start <span class="op">=</span> <span class="fl">5e3</span>, end <span class="op">=</span> <span class="fl">0</span>, rate <span class="op">=</span> <span class="va">rate_ea</span><span class="op">)</span>,</span>
<span></span>
<span>    <span class="co"># gene flow within Africa -- another parameter of interest</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/gene_flow.html" class="external-link">gene_flow</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">afr1</span>, to <span class="op">=</span> <span class="va">afr2</span>, start <span class="op">=</span> <span class="fl">50e3</span>, end <span class="op">=</span> <span class="fl">0</span>, rate <span class="op">=</span> <span class="va">rate_aa</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/gene_flow.html" class="external-link">gene_flow</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">afr2</span>, to <span class="op">=</span> <span class="va">afr1</span>, start <span class="op">=</span> <span class="fl">50e3</span>, end <span class="op">=</span> <span class="fl">0</span>, rate <span class="op">=</span> <span class="va">rate_aa</span><span class="op">)</span>,</span>
<span></span>
<span>    <span class="co"># Neanderthal introgression (fixed to 3%)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/gene_flow.html" class="external-link">gene_flow</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">nea</span>, to <span class="op">=</span> <span class="va">eur</span>, start <span class="op">=</span> <span class="fl">60e3</span>, end <span class="op">=</span> <span class="fl">50e3</span>, rate <span class="op">=</span> <span class="fl">0.03</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># generate a slendr model</span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/compile_model.html" class="external-link">compile_model</a></span><span class="op">(</span></span>
<span>    populations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">chimp</span>, <span class="va">anc</span>, <span class="va">nea</span>, <span class="va">afr1</span>, <span class="va">afr2</span>, <span class="va">eur</span><span class="op">)</span>, gene_flow <span class="op">=</span> <span class="va">gf</span>,</span>
<span>    generation_time <span class="op">=</span> <span class="fl">30</span>, serialize <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># specify sampling events</span></span>
<span>  <span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>    <span class="co"># Altai (70 kya) and Vindija (40 kya) Neanderthals</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/schedule_sampling.html" class="external-link">schedule_sampling</a></span><span class="op">(</span><span class="va">model</span>, times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">70e3</span>, <span class="fl">40e3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">nea</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="co"># Europeans from 40 kya to the present</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/schedule_sampling.html" class="external-link">schedule_sampling</a></span><span class="op">(</span><span class="va">model</span>, times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">40000</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">2000</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">eur</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="co"># two African populations</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/schedule_sampling.html" class="external-link">schedule_sampling</a></span><span class="op">(</span><span class="va">model</span>, times <span class="op">=</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">afr1</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">afr2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="co"># Chimpanzee outgroup</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/schedule_sampling.html" class="external-link">schedule_sampling</a></span><span class="op">(</span><span class="va">model</span>, times <span class="op">=</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">chimp</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">samples</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let’s check the model function by visualizing it (we set the gene-flow rates to arbitrary values, because this is purely a visualization test):</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_model</span> <span class="op">&lt;-</span> <span class="fu">model</span><span class="op">(</span>rate_ea <span class="op">=</span> <span class="fl">0.42</span>, rate_aa <span class="op">=</span> <span class="fl">0.42</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># we don't plot the gene flow arrows here for clarity</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/plot_model.html" class="external-link">plot_model</a></span><span class="op">(</span><span class="va">test_model</span>, gene_flow <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/plot_model.html" class="external-link">plot_model</a></span><span class="op">(</span><span class="va">test_model</span>, log <span class="op">=</span> <span class="cn">TRUE</span>, gene_flow <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="vignette-03-grids_files/figure-html/plot_model-1.png" width="640" style="display: block; margin: auto;"></p>
<p>The model looks OK, so in the next step we define tree-sequence popgen summary statistics we are interested in (again, just as we would for an ABC pipeline).</p>
</div>
<div class="section level3">
<h3 id="define-summary-statistics">2. Define summary statistics<a class="anchor" aria-label="anchor" href="#define-summary-statistics"></a>
</h3>
<p>Recall that we want to explore the impact of modern-human gene flow on Neanderthal ancestry as inferred using two ways of computing it: “indirect” and “direct” <span class="math inline">\(f_4\)</span>-ratio statistics.</p>
<p>Because our model samples 21 European individuals across the last 40 thousand years, we will compute the <span class="math inline">\(f_4\)</span>-ratio statistics on all of these individuals in sequence.</p>
<p><em>demografr</em> uses the R package <em>slendr</em> not just for encoding demographic models and popgen simulations, but also for analysis of tree sequences via its interface to the powerful library <a href="https://tskit.dev/tskit/docs/stable/introduction.html" class="external-link"><em>tskit</em></a>. One advantage of <em>slendr</em> is that it allows referring to simulated samples via their “symbolic names”. This means that, for instance, the first individual sampled from a population “eur” is named “eur_1”, the second is named as “eur_2”, etc. Therefore, we can capture the names of every European individual in a vector <code>X</code> by running:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"eur_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">21</span><span class="op">)</span></span>
<span><span class="va">X</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;  [1] "eur_1"  "eur_2"  "eur_3"  "eur_4"  "eur_5"  "eur_6"  "eur_7"  "eur_8" </span></span>
<span><span class="co">#&gt;  [9] "eur_9"  "eur_10" "eur_11" "eur_12" "eur_13" "eur_14" "eur_15" "eur_16"</span></span>
<span><span class="co">#&gt; [17] "eur_17" "eur_18" "eur_19" "eur_20" "eur_21"</span></span></code></pre>
<p>and use this vector as input for any tree-sequence function of <em>slendr</em>/<em>tskit</em>. Specifically, we can define the “indirect” and “direct” <span class="math inline">\(f_4\)</span>-ratio statistics in this way (using the equations defined in the figure above):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># compute the "indirect" f4-ratio statistic via slendr/tskit function ts_f4ratio,</span></span>
<span><span class="co"># returning its data frame output as it is</span></span>
<span><span class="va">indirect</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"eur_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">21</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/ts_f4ratio.html" class="external-link">ts_f4ratio</a></span><span class="op">(</span><span class="va">ts</span>, X <span class="op">=</span> <span class="va">X</span>, A <span class="op">=</span> <span class="st">"afr1_1"</span>, B <span class="op">=</span> <span class="st">"afr2_1"</span>, C <span class="op">=</span> <span class="st">"nea_2"</span>, O <span class="op">=</span> <span class="st">"chimp_1"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># compute the "direct" f4-ratio statistic via slendr/tskit function ts_f4ratio,</span></span>
<span><span class="co"># returning its data frame output as it is</span></span>
<span><span class="va">direct</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"eur_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">21</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/ts_f4ratio.html" class="external-link">ts_f4ratio</a></span><span class="op">(</span><span class="va">ts</span>, X <span class="op">=</span> <span class="va">X</span>, A <span class="op">=</span> <span class="st">"nea_2"</span>, B <span class="op">=</span> <span class="st">"nea_1"</span>, C <span class="op">=</span> <span class="st">"afr1_1"</span>, O <span class="op">=</span> <span class="st">"chimp_1"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Exactly as it’s the case for ABC, for the purposes of grid-based simulations we have to</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># bind both functions in a named list</span></span>
<span><span class="va">functions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>direct <span class="op">=</span> <span class="va">direct</span>, indirect <span class="op">=</span> <span class="va">indirect</span><span class="op">)</span></span></code></pre></div>
<p>This looks quite neat and tidy, but how can we make sure that our tree-sequence summary functions really work? We need a tree-sequence object as an input first! <em>demografr</em> provides an easy way to get an arbitrary tree sequence from a model function via its helper function <code>simulate_ts</code>. The simples way to use it is like this:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># we don't care about the parameter values, as we only want to get *some* tree sequence</span></span>
<span><span class="co"># (also, note we did not specify sequence length, recombination rate, etc.)</span></span>
<span><span class="va">ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_ts.html">simulate_ts</a></span><span class="op">(</span><span class="va">model</span>, parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>rate_ea <span class="op">=</span> <span class="fl">0.1</span>, rate_aa <span class="op">=</span> <span class="fl">0.15</span><span class="op">)</span>, mutation_rate <span class="op">=</span> <span class="fl">1e-8</span><span class="op">)</span></span></code></pre></div>
<p>With the tiny tree sequence for testing, we can now check if our tree-sequence functions work as they’re supposed to:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">functions</span><span class="op">$</span><span class="fu">direct</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 21 × 6</span></span></span>
<span><span class="co">#&gt;    X      A     B     C      O         alpha</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> eur_1  nea_2 nea_1 afr1_1 chimp_1 0.001<span style="text-decoration: underline;">56</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> eur_2  nea_2 nea_1 afr1_1 chimp_1 0      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> eur_3  nea_2 nea_1 afr1_1 chimp_1 0.434  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> eur_4  nea_2 nea_1 afr1_1 chimp_1 0.434  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> eur_5  nea_2 nea_1 afr1_1 chimp_1 0      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> eur_6  nea_2 nea_1 afr1_1 chimp_1 0.218  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> eur_7  nea_2 nea_1 afr1_1 chimp_1 0.001<span style="text-decoration: underline;">56</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> eur_8  nea_2 nea_1 afr1_1 chimp_1 0.001<span style="text-decoration: underline;">56</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> eur_9  nea_2 nea_1 afr1_1 chimp_1 0.001<span style="text-decoration: underline;">56</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> eur_10 nea_2 nea_1 afr1_1 chimp_1 0.001<span style="text-decoration: underline;">56</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 11 more rows</span></span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">functions</span><span class="op">$</span><span class="fu">indirect</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 21 × 6</span></span></span>
<span><span class="co">#&gt;    X      A      B      C     O          alpha</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> eur_1  afr1_1 afr2_1 nea_2 chimp_1  1.89   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> eur_2  afr1_1 afr2_1 nea_2 chimp_1  1.86   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> eur_3  afr1_1 afr2_1 nea_2 chimp_1 -<span style="color: #BB0000;">0.008</span><span style="color: #BB0000; text-decoration: underline;">32</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> eur_4  afr1_1 afr2_1 nea_2 chimp_1 -<span style="color: #BB0000;">0.008</span><span style="color: #BB0000; text-decoration: underline;">32</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> eur_5  afr1_1 afr2_1 nea_2 chimp_1  1.86   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> eur_6  afr1_1 afr2_1 nea_2 chimp_1  0.859  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> eur_7  afr1_1 afr2_1 nea_2 chimp_1  1.73   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> eur_8  afr1_1 afr2_1 nea_2 chimp_1  1.89   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> eur_9  afr1_1 afr2_1 nea_2 chimp_1  1.89   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> eur_10 afr1_1 afr2_1 nea_2 chimp_1  1.73   </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 11 more rows</span></span></span></code></pre>
<p>Excellent, we get the output tables from <code>ts_f4ratio</code> functions as we’re supposed to (and get one estimate for each of the 21):</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">functions</span><span class="op">$</span><span class="fu">direct</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="va">nrow</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 21</span></span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">functions</span><span class="op">$</span><span class="fu">indirect</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="va">nrow</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 21</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="define-a-parameter-grid">3. Define a parameter grid<a class="anchor" aria-label="anchor" href="#define-a-parameter-grid"></a>
</h3>
<p>Finally (and yet again, analogously to an equivalent ABC pipeline) we define parameters. Specifically, for a grid simulation, we define a data frame with one column for each parameter of the <em>slendr</em> model function (the names of parameter columns must match the model function arguments!). For this purpose, the function <code>crossing</code> from the <em>tidyr</em> R package is particularly helpful, so let’s use it here:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand.html" class="external-link">crossing</a></span><span class="op">(</span></span>
<span>  rate_aa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.25</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>  rate_ea <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.25</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 2</span></span></span>
<span><span class="co">#&gt;   rate_aa rate_ea</span></span>
<span><span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>       0   0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>       0   0.025</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>       0   0.05 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>       0   0.075</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>       0   0.1  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>       0   0.125</span></span></code></pre>
<p>In this way, we defined 121 parameter combinations and can finally proceed to the simulation inference.</p>
</div>
<div class="section level3">
<h3 id="perform-grid-based-simulations-compute-summary-statistics-for-each">4. Perform grid-based simulations, compute summary statistics for each<a class="anchor" aria-label="anchor" href="#perform-grid-based-simulations-compute-summary-statistics-for-each"></a>
</h3>
<p>In a final analogy to the ABC inference with <em>demografr</em>, we have a function <code><a href="../reference/simulate_grid.html">simulate_grid()</a></code> which performs the equivalent to <code><a href="../reference/simulate_abc.html">simulate_abc()</a></code>. In fact, the function has a nearly identical interface—we plug in the model function, our parameter grid, the list of summary tree-sequence functions, the number of simulation replicates to perform for each parameter combination (and a few other obvious parameters shown here).</p>
<p>First, we will set up an automated parallelization scheme using the <a href="https://cran.r-project.org/package=future" class="external-link"><em>future</em></a> R package:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># parallelize simulations across all CPUs of the machine</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multicore</span>, workers <span class="op">=</span> <span class="fu"><a href="https://parallelly.futureverse.org/reference/availableCores.html" class="external-link">availableCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>(See much more detail on parallelization of <em>demografr</em> inference pipelines in <a href="vignette-04-parallelization.html">this vignette</a>).</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_grid.html">simulate_grid</a></span><span class="op">(</span></span>
<span>  <span class="va">model</span>, <span class="va">grid</span>, <span class="va">functions</span>, replicates <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  sequence_length <span class="op">=</span> <span class="fl">25e6</span>, mutation_rate <span class="op">=</span> <span class="fl">1e-8</span>, recombination_rate <span class="op">=</span> <span class="fl">1e-8</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>The total runtime for the grid simulations was 0 hours 22 minutes 14 seconds parallelized across 96 CPUs.</strong></p>
</div>
<div class="section level3">
<h3 id="analyze-results">5. Analyze results<a class="anchor" aria-label="anchor" href="#analyze-results"></a>
</h3>
<p>The function <code><a href="../reference/simulate_grid.html">simulate_grid()</a></code> returns all results in a data frame object in the following format:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">results</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6,050 × 5</span></span></span>
<span><span class="co">#&gt;      rep rate_aa rate_ea direct            indirect         </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1       0   0     <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span> <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     1       0   0.025 <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span> <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     1       0   0.05  <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span> <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     1       0   0.075 <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span> <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     1       0   0.1   <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span> <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     1       0   0.125 <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span> <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     1       0   0.15  <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span> <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     1       0   0.175 <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span> <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     1       0   0.2   <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span> <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     1       0   0.225 <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span> <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 6,040 more rows</span></span></span></code></pre>
<p>The first column indicates a replicate number, the following few columns are the values of the parameter grid. Most important are the last columns, though, each named after a single summary statistics. For conciseness, these summary statistics are stored as so-called <a href="https://dcl-prog.stanford.edu/list-columns.html" class="external-link">“list columns”</a>—for each replicate and each parameter combination, these columns store the summary statistics as “nested” data frames like this:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span><span class="op">$</span><span class="va">direct</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 21 × 6</span></span></span>
<span><span class="co">#&gt;    X      A     B     C      O        alpha</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> eur_1  nea_2 nea_1 afr1_1 chimp_1 0.056<span style="text-decoration: underline;">1</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> eur_2  nea_2 nea_1 afr1_1 chimp_1 0.060<span style="text-decoration: underline;">3</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> eur_3  nea_2 nea_1 afr1_1 chimp_1 0.081<span style="text-decoration: underline;">7</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> eur_4  nea_2 nea_1 afr1_1 chimp_1 0.102 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> eur_5  nea_2 nea_1 afr1_1 chimp_1 0.066<span style="text-decoration: underline;">9</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> eur_6  nea_2 nea_1 afr1_1 chimp_1 0.077<span style="text-decoration: underline;">3</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> eur_7  nea_2 nea_1 afr1_1 chimp_1 0.074<span style="text-decoration: underline;">6</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> eur_8  nea_2 nea_1 afr1_1 chimp_1 0.067<span style="text-decoration: underline;">4</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> eur_9  nea_2 nea_1 afr1_1 chimp_1 0.051<span style="text-decoration: underline;">4</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> eur_10 nea_2 nea_1 afr1_1 chimp_1 0.044<span style="text-decoration: underline;">1</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 11 more rows</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 21 × 6</span></span></span>
<span><span class="co">#&gt;    X      A     B     C      O         alpha</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> eur_1  nea_2 nea_1 afr1_1 chimp_1 0.010<span style="text-decoration: underline;">6</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> eur_2  nea_2 nea_1 afr1_1 chimp_1 0.001<span style="text-decoration: underline;">53</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> eur_3  nea_2 nea_1 afr1_1 chimp_1 0.006<span style="text-decoration: underline;">17</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> eur_4  nea_2 nea_1 afr1_1 chimp_1 0.025<span style="text-decoration: underline;">0</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> eur_5  nea_2 nea_1 afr1_1 chimp_1 0.011<span style="text-decoration: underline;">1</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> eur_6  nea_2 nea_1 afr1_1 chimp_1 0.007<span style="text-decoration: underline;">80</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> eur_7  nea_2 nea_1 afr1_1 chimp_1 0.018<span style="text-decoration: underline;">9</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> eur_8  nea_2 nea_1 afr1_1 chimp_1 0.014<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> eur_9  nea_2 nea_1 afr1_1 chimp_1 0.012<span style="text-decoration: underline;">9</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> eur_10 nea_2 nea_1 afr1_1 chimp_1 0.006<span style="text-decoration: underline;">78</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 11 more rows</span></span></span></code></pre>
<p>List columns are very efficient and concise for storing complex data like this, but in order to be able to analyze data stored in them, we need a function <a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link"><code>unnest()</code></a> from <em>tidyverse</em>, which “explodes” a list-column with stored data frames into a wider data frame which can be immediately analyzed. In this example:</p>
<p><strong>Direct f4-ratio:</strong></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">unnest</span><span class="op">(</span><span class="va">direct</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 127,050 × 10</span></span></span>
<span><span class="co">#&gt;      rep rate_aa rate_ea X      A     B     C      O        alpha indirect</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1       0       0 eur_1  nea_2 nea_1 afr1_1 chimp_1 0.056<span style="text-decoration: underline;">1</span> <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     1       0       0 eur_2  nea_2 nea_1 afr1_1 chimp_1 0.060<span style="text-decoration: underline;">3</span> <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     1       0       0 eur_3  nea_2 nea_1 afr1_1 chimp_1 0.081<span style="text-decoration: underline;">7</span> <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     1       0       0 eur_4  nea_2 nea_1 afr1_1 chimp_1 0.102  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     1       0       0 eur_5  nea_2 nea_1 afr1_1 chimp_1 0.066<span style="text-decoration: underline;">9</span> <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     1       0       0 eur_6  nea_2 nea_1 afr1_1 chimp_1 0.077<span style="text-decoration: underline;">3</span> <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     1       0       0 eur_7  nea_2 nea_1 afr1_1 chimp_1 0.074<span style="text-decoration: underline;">6</span> <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     1       0       0 eur_8  nea_2 nea_1 afr1_1 chimp_1 0.067<span style="text-decoration: underline;">4</span> <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     1       0       0 eur_9  nea_2 nea_1 afr1_1 chimp_1 0.051<span style="text-decoration: underline;">4</span> <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     1       0       0 eur_10 nea_2 nea_1 afr1_1 chimp_1 0.044<span style="text-decoration: underline;">1</span> <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 127,040 more rows</span></span></span></code></pre>
<p><strong>Indirect f4-ratio:</strong></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">unnest</span><span class="op">(</span><span class="va">indirect</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 127,050 × 10</span></span></span>
<span><span class="co">#&gt;      rep rate_aa rate_ea direct            X      A      B     C     O     alpha</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1       0       0 <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span> eur_1  afr1_1 afr2… nea_2 chim… 0.951</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     1       0       0 <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span> eur_2  afr1_1 afr2… nea_2 chim… 0.965</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     1       0       0 <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span> eur_3  afr1_1 afr2… nea_2 chim… 0.928</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     1       0       0 <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span> eur_4  afr1_1 afr2… nea_2 chim… 0.889</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     1       0       0 <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span> eur_5  afr1_1 afr2… nea_2 chim… 0.960</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     1       0       0 <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span> eur_6  afr1_1 afr2… nea_2 chim… 0.943</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     1       0       0 <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span> eur_7  afr1_1 afr2… nea_2 chim… 0.971</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     1       0       0 <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span> eur_8  afr1_1 afr2… nea_2 chim… 0.942</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     1       0       0 <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span> eur_9  afr1_1 afr2… nea_2 chim… 0.984</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     1       0       0 <span style="color: #949494;">&lt;tibble [21 × 6]&gt;</span> eur_10 afr1_1 afr2… nea_2 chim… 0.951</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 127,040 more rows</span></span></span></code></pre>
<p><strong>Note that unnesting each results column creates a plain old data frame which can be analyzed by whatever means you find convenient.</strong></p>
<p>Because we were interested in the behavior of trajectories of indirect and direct estimates of Neanderthal ancestry over time, we will first create a small data frame indicating the times of sampling of each simulated European individual. We will use this small data frame for join operations for the purpose of plotting below:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"eur_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">21</span><span class="op">)</span>,</span>
<span>  time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">40000</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="within-african-gene-flow-vs-inference-of-neanderthal-ancestry">Within-African gene flow vs inference of Neanderthal ancestry<a class="anchor" aria-label="anchor" href="#within-african-gene-flow-vs-inference-of-neanderthal-ancestry"></a>
</h3>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">indirect</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">rate_ea</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>          <span class="co"># ignore models with Eurasian -&gt; African gene flow</span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">samples</span>, by <span class="op">=</span> <span class="st">"X"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># join the samples table to add time information</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">alpha</span>, color <span class="op">=</span> <span class="va">rate_aa</span>, group <span class="op">=</span> <span class="va">rate_aa</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"smooth"</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0.03</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"black"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"years before present"</span>, y <span class="op">=</span> <span class="st">"Neanderthal ancestry proportion"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fl">40000</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"The effect of within-Africa gene flow (afr1 &lt;-&gt; afr2) on 'indirect f4-ratio'"</span>,</span>
<span>            <span class="st">"Red line indicates the true Neanderthal ancestry proportion"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; `geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = "cs")'</span></span></code></pre>
<p><img src="vignette-03-grids_files/figure-html/aa_indirect-1.png" width="640" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">direct</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">rate_ea</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">samples</span>, by <span class="op">=</span> <span class="st">"X"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">alpha</span>, color <span class="op">=</span> <span class="va">rate_aa</span>, group <span class="op">=</span> <span class="va">rate_aa</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"smooth"</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0.03</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"black"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"years before present"</span>, y <span class="op">=</span> <span class="st">"Neanderthal ancestry proportion"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fl">40000</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"The effect of within-Africa gene flow (afr1 &lt;-&gt; afr2) on 'direct f4-ratio'"</span>,</span>
<span>            <span class="st">"Red line indicates the true Neanderthal ancestry proportion"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; `geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = "cs")'</span></span></code></pre>
<p><img src="vignette-03-grids_files/figure-html/aa_direct-1.png" width="640" style="display: block; margin: auto;"></p>
<p><strong>We can see that increasing rates of gene flows <em>within Africa</em> shifts apparent Neanderthal ancestry proportions inferred using “indirect” <span class="math inline">\(f_4\)</span>-ratio increasingly upwards</strong> (compare the estimated trajectories to the true proportion shown as dashed line). However, the “direct” <span class="math inline">\(f_4\)</span>-ratio remains stable.</p>
</div>
<div class="section level3">
<h3 id="eurasia---africa-gene-flow-vs-inference-of-neanderthal-ancestry">Eurasia -&gt; Africa gene flow vs inference of Neanderthal ancestry<a class="anchor" aria-label="anchor" href="#eurasia---africa-gene-flow-vs-inference-of-neanderthal-ancestry"></a>
</h3>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">indirect</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">rate_aa</span> <span class="op">==</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">samples</span>, by <span class="op">=</span> <span class="st">"X"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">alpha</span>, color <span class="op">=</span> <span class="va">rate_ea</span>, group <span class="op">=</span> <span class="va">rate_ea</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"smooth"</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0.03</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"black"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"years before present"</span>, y <span class="op">=</span> <span class="st">"Neanderthal ancestry proportion"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fl">40000</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"The effect of Eurasia -&gt; Africa gene flow on 'indirect f4-ratio'"</span>,</span>
<span>            <span class="st">"Red line indicates the true Neanderthal ancestry proportion"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; `geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = "cs")'</span></span></code></pre>
<p><img src="vignette-03-grids_files/figure-html/ea_indirect-1.png" width="640" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">direct</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">rate_aa</span> <span class="op">==</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">samples</span>, by <span class="op">=</span> <span class="st">"X"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">alpha</span>, color <span class="op">=</span> <span class="va">rate_ea</span>, group <span class="op">=</span> <span class="va">rate_ea</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"smooth"</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0.03</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"black"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"years before present"</span>, y <span class="op">=</span> <span class="st">"Neanderthal ancestry proportion"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fl">40000</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"The effect of Eurasia -&gt; Africa gene flow on 'direct f4-ratio'"</span>,</span>
<span>            <span class="st">"Red line indicates the true Neanderthal ancestry proportion"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; `geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = "cs")'</span></span></code></pre>
<p><img src="vignette-03-grids_files/figure-html/ea_direct-1.png" width="640" style="display: block; margin: auto;"></p>
<p><strong>Even more importantly, gene flow from Eurasia back into Africa creates an artificial decline of Neanderthal ancestry if measured via “indirect” <span class="math inline">\(f_4\)</span>-ratio statistic!</strong> However, the “direct” <span class="math inline">\(f_4\)</span>-ratio remains stable.</p>
</div>
</div>
<div class="section level2">
<h2 id="comparison-with-the-result-by-petr-et-al--pnas-2018">Comparison with the result by Petr <em>et al.</em> (PNAS 2018)<a class="anchor" aria-label="anchor" href="#comparison-with-the-result-by-petr-et-al--pnas-2018"></a>
</h2>
<p>As we can see, the very simple analysis described in this code (worth a couple of dozen lines of easy-to-read R code) can qualitatively replicate the much more elaborate original result:</p>
<p><img src="images/petr_2018b.png" style="width:80.0%"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Martin Petr.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
