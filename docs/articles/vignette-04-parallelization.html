<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="demografr">
<title>Parallelization options • demografr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Parallelization options">
<meta property="og:description" content="demografr">
<meta property="og:image" content="https://bodkan.net/demografr/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">demografr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">
    <span class="fa fa-question-circle"></span>
     
    Reference
  </a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown--articles">
    <span class="fa fa-book"></span>
     
    Articles
  </a>
  <div class="dropdown-menu" aria-labelledby="dropdown--articles">
    <a class="dropdown-item" href="../articles/vignette-01-basics.html">A basic ABC workflow</a>
    <a class="dropdown-item" href="../articles/vignette-02-priors.html">Specifying prior distributions</a>
    <a class="dropdown-item" href="../articles/vignette-03-grids.html">Support for grid simulations</a>
    <a class="dropdown-item" href="../articles/vignette-04-parallelization.html">Parallelization options</a>
    <a class="dropdown-item" href="../articles/vignette-05-custom.html">Custom inference using SLiM or Python</a>
    <a class="dropdown-item" href="../articles/vignette-06-diagnostics.html">Model selection and other diagnostics</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/bodkan/demografr/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">

<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Parallelization options</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bodkan/demografr/blob/HEAD/vignettes/vignette-04-parallelization.Rmd" class="external-link"><code>vignettes/vignette-04-parallelization.Rmd</code></a></small>
      <div class="d-none name"><code>vignette-04-parallelization.Rmd</code></div>
    </div>

    
    
<p>⚠️⚠️⚠️</p>
<p><strong>The <em>demografr</em> R package is still under active development!</strong></p>
<p>⚠️⚠️⚠️</p>
<p>In addition to ease of programming, one of the main selling points of <em>demografr</em> is computational efficiency. Although R isn’t exactly known for computational speed, by utilizing <em>msprime</em> (and, optionally, SLiM) for simulation and the <em>tskit</em> tree-sequence module for population genetic computation without having to rely on saving files to disk, inference pipelines written with <em>demografr</em> are very fast and efficient.</p>
<p>Still, optimized means of simulation and computation can only get us so far. Especially for computationally very heavy workflows such an ABC, parallelization is absolutely crucial. To this end, <em>demografr</em> provides two ways of parallelization. One is more sophisticated and easier to do, but it does require a little bit of setup. Another is more straightforward but a little less convenient.</p>
<p>In this vignette, we will briefly describe both methods, using the <code><a href="../reference/simulate_grid.html">simulate_grid()</a></code> function for simplicity and this toy population genetic model:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bodkan/demografr" class="external-link">demografr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bodkan/slendr" class="external-link">slendr</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; The legacy packages maptools, rgdal, and rgeos, underpinning the sp package,</span></span>
<span><span class="co">#&gt; which was just loaded, will retire in October 2023.</span></span>
<span><span class="co">#&gt; Please refer to R-spatial evolution reports for details, especially</span></span>
<span><span class="co">#&gt; https://r-spatial.org/r/2023/05/15/evolution4.html.</span></span>
<span><span class="co">#&gt; It may be desirable to make the sf package available;</span></span>
<span><span class="co">#&gt; package maintainers should consider adding sf to Suggests:.</span></span>
<span><span class="co">#&gt; The sp package is now running under evolution status 2</span></span>
<span><span class="co">#&gt;      (status 2 uses the sf package in place of rgdal)</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/slendr/man/init_env.html" class="external-link">init_env</a></span><span class="op">(</span>quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">Ne_p1</span>, <span class="va">Ne_p2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/population.html" class="external-link">population</a></span><span class="op">(</span><span class="st">"p1"</span>, time <span class="op">=</span> <span class="fl">10000</span>, N <span class="op">=</span> <span class="va">Ne_p1</span><span class="op">)</span></span>
<span>  <span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/population.html" class="external-link">population</a></span><span class="op">(</span><span class="st">"p2"</span>, time <span class="op">=</span> <span class="fl">5000</span>, N <span class="op">=</span> <span class="va">Ne_p2</span>, parent <span class="op">=</span> <span class="va">p1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/compile_model.html" class="external-link">compile_model</a></span><span class="op">(</span>populations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span><span class="op">)</span>, generation_time <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let’s say we want to explore the levels of genetic diversity in both populations across the following parameter grid (note that this grid is extremely small in order to make this example quick to run):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'tidyr'</span></span></code></pre>
<pre><code><span><span class="co">#&gt; The following object is masked from 'package:demografr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     unpack</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand.html" class="external-link">crossing</a></span><span class="op">(</span></span>
<span>  Ne_p1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">100</span>, <span class="fl">1000</span><span class="op">)</span>,</span>
<span>  Ne_p2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">100</span>, <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">grid</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 9 × 2</span></span></span>
<span><span class="co">#&gt;   Ne_p1 Ne_p2</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>    10    10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>    10   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>    10  <span style="text-decoration: underline;">1</span>000</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>   100    10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>   100   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>   100  <span style="text-decoration: underline;">1</span>000</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span>  <span style="text-decoration: underline;">1</span>000    10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span>  <span style="text-decoration: underline;">1</span>000   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">9</span>  <span style="text-decoration: underline;">1</span>000  <span style="text-decoration: underline;">1</span>000</span></span></code></pre>
<p>Here is our summary function:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">functions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  diversity <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/ts_names.html" class="external-link">ts_names</a></span><span class="op">(</span><span class="va">ts</span>, split <span class="op">=</span> <span class="st">"pop"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/ts_diversity.html" class="external-link">ts_diversity</a></span><span class="op">(</span><span class="va">ts</span>, sample_sets <span class="op">=</span> <span class="va">samples</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Just to verify we have set up the components of our workflow correctly, let’s quickly simulate a tree sequence and try to compute genetic diversity in both populations using our summary function:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_model.html">simulate_model</a></span><span class="op">(</span><span class="va">model</span>, parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Ne_p1 <span class="op">=</span> <span class="fl">100</span>, Ne_p2 <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>,</span>
<span>                     sequence_length <span class="op">=</span> <span class="fl">1e6</span>, recombination_rate <span class="op">=</span> <span class="fl">0</span>, mutation_rate <span class="op">=</span> <span class="fl">1e-8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">functions</span><span class="op">$</span><span class="fu">diversity</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 2</span></span></span>
<span><span class="co">#&gt;   set    diversity</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> p1    0.000<span style="text-decoration: underline;">003</span>53</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> p2    0.000<span style="text-decoration: underline;">030</span>0</span></span></code></pre>
<p>Everything works! <strong>Now, how can we parallelize the computation of diversity across all parameters of the grid?</strong></p>
<div class="section level2">
<h2 id="implicit-parallelization-via-future">1. Implicit parallelization via <em>future</em><a class="anchor" aria-label="anchor" href="#implicit-parallelization-via-future"></a>
</h2>
<p>The simplest way to parallelize <em>demografr</em> workflow is via the R package <a href="https://cran.r-project.org/package=future" class="external-link"><em>future</em></a>.</p>
<p>The magic of <em>future</em> lies in its ability to set up parallelized schemes of arbitrary topologies by automatic scheduling of jobs across a given number of CPUs distributed even across several remote compute servers.</p>
<p>Going into detail in setting up <em>future</em>-based parallelization would be too far out of scope of this simple vignette (or <em>demografr</em>’s documentation in general). Luckily, once <em>future</em> parallelization is set up, it doesn’t matter whether the computation is done by <em>demografr</em> or anything else, as the <em>future</em> architecture is completely general.</p>
<p>In order to use <em>future</em> effectively, you should study its documentation and tutorials (a good start would be the vignette <a href="https://cran.r-project.org/package=future" class="external-link">here</a>), but here is a brief introduction focused on parallelizing a toy <em>demografr</em> analysis set up above:</p>
<div class="section level3">
<h3 id="sequential-run">Sequential run<a class="anchor" aria-label="anchor" href="#sequential-run"></a>
</h3>
<p>By default, if we would run <code><a href="../reference/simulate_grid.html">simulate_grid()</a></code>, all simulations would be run <em>sequentially</em>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_grid.html">simulate_grid</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">grid</span>, <span class="va">functions</span>, replicates <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                      sequence_length <span class="op">=</span> <span class="fl">10000</span>, recombination_rate <span class="op">=</span> <span class="fl">1e-8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 90 × 4</span></span></span>
<span><span class="co">#&gt;      rep Ne_p1 Ne_p2 diversity       </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1    10    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     1    10   100 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     1    10  <span style="text-decoration: underline;">1</span>000 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     1   100    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     1   100   100 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     1   100  <span style="text-decoration: underline;">1</span>000 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     1  <span style="text-decoration: underline;">1</span>000    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     1  <span style="text-decoration: underline;">1</span>000   100 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     1  <span style="text-decoration: underline;">1</span>000  <span style="text-decoration: underline;">1</span>000 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     2    10    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 80 more rows</span></span></span></code></pre>
<p><strong>The total runtime for the grid simulations was 0 hours 5 minutes 21 seconds parallelized across 96 CPUs.</strong></p>
</div>
<div class="section level3">
<h3 id="parallelization-across-cpus-of-one-machine">Parallelization across CPUs of one machine<a class="anchor" aria-label="anchor" href="#parallelization-across-cpus-of-one-machine"></a>
</h3>
<p>In order to distribute simulations across all (or some) available CPU cores of your machine, you only need to put the following bit of R code <em>before</em> your call to <code><a href="../reference/simulate_grid.html">simulate_grid()</a></code>. For instance, on my personal laptop which has 10 CPUs, I can run the above grid simulations using all available CPUs like this.</p>
<p>First we setup <em>future</em>:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="co"># use 10 CPUs</span></span></code></pre></div>
<p>Then we can run the simulations <strong>without having to do anything else!</strong> This last point is important: <em>demografr</em> can automatically leverage whatever parallelization scheme you set up via <em>future</em>’s function <code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan()</a></code>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_grid.html">simulate_grid</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">grid</span>, <span class="va">functions</span>, replicates <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                      sequence_length <span class="op">=</span> <span class="fl">100000</span>, recombination_rate <span class="op">=</span> <span class="fl">1e-8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 90 × 4</span></span></span>
<span><span class="co">#&gt;      rep Ne_p1 Ne_p2 diversity       </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1    10    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     1    10   100 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     1    10  <span style="text-decoration: underline;">1</span>000 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     1   100    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     1   100   100 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     1   100  <span style="text-decoration: underline;">1</span>000 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     1  <span style="text-decoration: underline;">1</span>000    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     1  <span style="text-decoration: underline;">1</span>000   100 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     1  <span style="text-decoration: underline;">1</span>000  <span style="text-decoration: underline;">1</span>000 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     2    10    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 80 more rows</span></span></span></code></pre>
<p><strong>The total runtime for the grid simulations was 0 hours 0 minutes 44 seconds parallelized across 96 CPUs.</strong></p>
<p>Notice the speed up even for this trivial simulation pipeline!</p>
</div>
<div class="section level3">
<h3 id="parallelization-across-cpus-of-multiple-machines">Parallelization across CPUs of multiple machines<a class="anchor" aria-label="anchor" href="#parallelization-across-cpus-of-multiple-machines"></a>
</h3>
<p>If you read the documentation of the <em>future</em> package (which you really <a href="https://cran.r-project.org/package=future" class="external-link">should</a>), you will discover many more options for parallelization giving you near limitless options for scheduling parallel simulations.</p>
<p>For instance, imagine you have access to remote machines <code>server01</code>, <code>server02</code>, <code>server03</code>, all with available R as well as <em>demografr</em> and <em>slendr</em> R packages, with set up <em>slendr</em> environments. In other words, you can start an R interpreter on each of these machines and eventually call:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bodkan/demografr" class="external-link">demografr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bodkan/slendr" class="external-link">slendr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/slendr/man/init_env.html" class="external-link">init_env</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; The interface to all required Python modules has been activated.</span></span></code></pre>
<p>Then, you can distribute the <code><a href="../reference/simulate_grid.html">simulate_grid()</a></code> run (but also <code><a href="../reference/simulate_abc.html">simulate_abc()</a></code>, of course!) simply by adjusting the <code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan()</a></code> setup like this:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hostnames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"server01"</span>, <span class="st">"server02"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="va">hostnames</span><span class="op">)</span></span></code></pre></div>
<p>We won’t be running this example here in practice because the “server01”, etc., obviously don’t exist, but hopefully you get the idea.</p>
<p>In short, the <em>future</em> R package (and it’s support provided by <em>demografr</em>) makes it very easy to set up arbitrary parallelization schemes without doing additional work beyond setting up the parallelization <code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="for-completeness">For completeness<a class="anchor" aria-label="anchor" href="#for-completeness"></a>
</h3>
<p>By default, if you don’t set up any <code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan()</a></code> at all, the simulation runs of <em>demografr</em> will be run in a sequential manner, because the default mode of operation for the <em>future</em> R package is the following plan:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></code></pre></div>
<p>But this is just for completeness. It’s not something that makes much sense to do in practice, perhaps beyond debugging parallelization issues.</p>
</div>
</div>
<div class="section level2">
<h2 id="manual-parallelization">2. “Manual” parallelization<a class="anchor" aria-label="anchor" href="#manual-parallelization"></a>
</h2>
<p>In my personal experience, it can be a bit of a hassle to distribute jobs across different machines, despite the conveniences of the <em>future</em> R package. If you’re having such problems, I first <em>highly</em> encourage you to <a href="https://cran.r-project.org/package=future" class="external-link">read</a> the basic overview vignette and look up troubleshooting advice on Google.</p>
<p>Still, <em>demografr</em> provides rudimentary support for “manual” paralelization across multiple machines (each of those machines parallelizing on multiple CPUs), followed by merging simulation runs into a single data set.</p>
<p>To demonstrate this, let’s pretend we ran five simulation grid runs across two different computers like this (we were originally interested in distributing 10 replicates, so we’ll run two times five replicates individually):</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">run1_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".rds"</span><span class="op">)</span></span>
<span><span class="va">run2_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># on machine #1</span></span>
<span><span class="fu"><a href="../reference/simulate_grid.html">simulate_grid</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">grid</span>, <span class="va">functions</span>, replicates <span class="op">=</span> <span class="fl">5</span>,</span>
<span>              sequence_length <span class="op">=</span> <span class="fl">100000</span>, recombination_rate <span class="op">=</span> <span class="fl">1e-8</span>, file <span class="op">=</span> <span class="va">run1_file</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># on machine #2</span></span>
<span><span class="fu"><a href="../reference/simulate_grid.html">simulate_grid</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">grid</span>, <span class="va">functions</span>, replicates <span class="op">=</span> <span class="fl">5</span>,</span>
<span>              sequence_length <span class="op">=</span> <span class="fl">100000</span>, recombination_rate <span class="op">=</span> <span class="fl">1e-8</span>, file <span class="op">=</span> <span class="va">run2_file</span><span class="op">)</span></span></code></pre></div>
<p>Then, once we collected the individual <code>.rds</code> files on a single computer from the remote machines (perhaps using something like the <code>scp</code> unix command), we can use another <em>demografr</em> function <code><a href="../reference/combine_data.html">combine_data()</a></code> to merge all individual runs into a single result:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/combine_data.html">combine_data</a></span><span class="op">(</span><span class="va">run1_file</span>, <span class="va">run2_file</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 90 × 4</span></span></span>
<span><span class="co">#&gt;      rep Ne_p1 Ne_p2 diversity       </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1    10    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     1    10   100 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     1    10  <span style="text-decoration: underline;">1</span>000 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     1   100    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     1   100   100 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     1   100  <span style="text-decoration: underline;">1</span>000 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     1  <span style="text-decoration: underline;">1</span>000    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     1  <span style="text-decoration: underline;">1</span>000   100 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     1  <span style="text-decoration: underline;">1</span>000  <span style="text-decoration: underline;">1</span>000 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     2    10    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 80 more rows</span></span></span></code></pre>
<p>For each combination of parameters we ran five replicates across “two different machines”, totaling 9 x 5 x 2 = 90 simulations, so we should get the same number of rows in the merged data frame:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 90</span></span></code></pre>
<p>One thing to note that <code><a href="../reference/simulate_grid.html">simulate_grid()</a></code> as well as <code><a href="../reference/simulate_abc.html">simulate_abc()</a></code> really do save standard RDS files as one normally would using function <code><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS()</a></code> (in fact, they use this function internally). An additional benefit of using this approach combined with <code><a href="../reference/combine_data.html">combine_data()</a></code> is that these functions provide additional sanity checks making sure that the simulation data sets being merged are consistent (coming from the same model function, with the same priors or summary statistics, etc.).</p>
<p>For completeness, <code><a href="../reference/combine_data.html">combine_data()</a></code> not only accepts file paths as individual function arguments but also file names as vectors, as well as individual data frame objects generated by <code><a href="../reference/simulate_grid.html">simulate_grid()</a></code> and <code><a href="../reference/simulate_abc.html">simulate_abc()</a></code>. In other words, the following approaches will all result in the same combined data set:</p>
<p><strong>Merging data from serialized data files:</strong></p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/combine_data.html">combine_data</a></span><span class="op">(</span><span class="va">run1_file</span>, <span class="va">run2_file</span><span class="op">)</span></span>
<span><span class="va">combined2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/combine_data.html">combine_data</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">run1_file</span>, <span class="va">run2_file</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>Merging data objects themselves directly:</strong></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">run1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_grid.html">simulate_grid</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">grid</span>, <span class="va">functions</span>, replicates <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                      sequence_length <span class="op">=</span> <span class="fl">100000</span>, recombination_rate <span class="op">=</span> <span class="fl">1e-8</span><span class="op">)</span></span>
<span><span class="va">run2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_grid.html">simulate_grid</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">grid</span>, <span class="va">functions</span>, replicates <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                      sequence_length <span class="op">=</span> <span class="fl">100000</span>, recombination_rate <span class="op">=</span> <span class="fl">1e-8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/combine_data.html">combine_data</a></span><span class="op">(</span><span class="va">run1</span>, <span class="va">run2</span><span class="op">)</span></span>
<span><span class="va">combined4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/combine_data.html">combine_data</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">run1</span>, <span class="va">run2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>All <code><a href="../reference/combine_data.html">combine_data()</a></code> approaches give the same result:</strong></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">combined1</span>, <span class="va">combined2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] TRUE</span></span></code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">combined3</span>, <span class="va">combined4</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] TRUE</span></span></code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">combined2</span>, <span class="va">combined3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] TRUE</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Martin Petr.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
