<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Parallelization options • demografr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Parallelization options">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">demografr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fa-question-circle"></span> Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fa-book"></span> Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/vignette-01-basics.html">A basic ABC workflow</a></li>
    <li><a class="dropdown-item" href="../articles/vignette-02-priors.html">Specifying prior distributions</a></li>
    <li><a class="dropdown-item" href="../articles/vignette-03-grids.html">Support for grid simulations</a></li>
    <li><a class="dropdown-item" href="../articles/vignette-04-parallelization.html">Parallelization options</a></li>
    <li><a class="dropdown-item" href="../articles/vignette-05-custom.html">Custom inference using SLiM or Python</a></li>
    <li><a class="dropdown-item" href="../articles/vignette-06-diagnostics.html">Model selection and other diagnostics</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bodkan/demografr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Parallelization options</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bodkan/demografr/blob/HEAD/vignettes/vignette-04-parallelization.Rmd" class="external-link"><code>vignettes/vignette-04-parallelization.Rmd</code></a></small>
      <div class="d-none name"><code>vignette-04-parallelization.Rmd</code></div>
    </div>

    
    
<p>⚠️⚠️⚠️</p>
<p><strong>The <em>demografr</em> R package is still under active
development!</strong></p>
<p>⚠️⚠️⚠️</p>
<p>In addition to ease of programming, one of the main selling points of
<em>demografr</em> is computational efficiency. Although R isn’t exactly
known for computational speed, by utilizing <em>msprime</em> (and,
optionally, SLiM) for simulation and the <em>tskit</em> tree-sequence
module for population genetic computation without having to rely on
saving files to disk, inference pipelines written with
<em>demografr</em> are very fast and efficient.</p>
<p>Still, optimized means of simulation and computation can only get us
so far. Especially for computationally very heavy workflows such an ABC,
parallelization is absolutely crucial. To this end, <em>demografr</em>
provides two ways of parallelization. One is more sophisticated and
easier to do, but it does require a little bit of setup. Another is more
straightforward but a little less convenient.</p>
<p>In this vignette, we will briefly describe both methods, using the
<code><a href="../reference/simulate_grid.html">simulate_grid()</a></code> function for simplicity and this toy
population genetic model:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bodkan/demografr" class="external-link">demografr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bodkan/slendr" class="external-link">slendr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/slendr/man/init_env.html" class="external-link">init_env</a></span><span class="op">(</span>quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">Ne_p1</span>, <span class="va">Ne_p2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/population.html" class="external-link">population</a></span><span class="op">(</span><span class="st">"p1"</span>, time <span class="op">=</span> <span class="fl">10000</span>, N <span class="op">=</span> <span class="va">Ne_p1</span><span class="op">)</span></span>
<span>  <span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/population.html" class="external-link">population</a></span><span class="op">(</span><span class="st">"p2"</span>, time <span class="op">=</span> <span class="fl">5000</span>, N <span class="op">=</span> <span class="va">Ne_p2</span>, parent <span class="op">=</span> <span class="va">p1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/compile_model.html" class="external-link">compile_model</a></span><span class="op">(</span>populations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span><span class="op">)</span>, generation_time <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let’s say we want to explore the levels of genetic diversity in both
populations across the following parameter grid (note that this grid is
extremely small in order to make this example quick to run):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'tidyr'</span></span></code></pre>
<pre><code><span><span class="co">#&gt; The following object is masked from 'package:demografr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     unpack</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand.html" class="external-link">crossing</a></span><span class="op">(</span></span>
<span>  Ne_p1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">100</span>, <span class="fl">1000</span><span class="op">)</span>,</span>
<span>  Ne_p2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">100</span>, <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">grid</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 9 × 2</span></span></span>
<span><span class="co">#&gt;   Ne_p1 Ne_p2</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>    10    10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>    10   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>    10  <span style="text-decoration: underline;">1</span>000</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>   100    10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>   100   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>   100  <span style="text-decoration: underline;">1</span>000</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span>  <span style="text-decoration: underline;">1</span>000    10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span>  <span style="text-decoration: underline;">1</span>000   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">9</span>  <span style="text-decoration: underline;">1</span>000  <span style="text-decoration: underline;">1</span>000</span></span></code></pre>
<p>Here is our summary function:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">functions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  diversity <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/ts_names.html" class="external-link">ts_names</a></span><span class="op">(</span><span class="va">ts</span>, split <span class="op">=</span> <span class="st">"pop"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/ts_diversity.html" class="external-link">ts_diversity</a></span><span class="op">(</span><span class="va">ts</span>, sample_sets <span class="op">=</span> <span class="va">samples</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Just to verify we have set up the components of our workflow
correctly, let’s quickly simulate a tree sequence and try to compute
genetic diversity in both populations using our summary function:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_model.html">simulate_model</a></span><span class="op">(</span><span class="va">model</span>, parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Ne_p1 <span class="op">=</span> <span class="fl">100</span>, Ne_p2 <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>,</span>
<span>                     sequence_length <span class="op">=</span> <span class="fl">1e6</span>, recombination_rate <span class="op">=</span> <span class="fl">0</span>, mutation_rate <span class="op">=</span> <span class="fl">1e-8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">functions</span><span class="op">$</span><span class="fu">diversity</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 2</span></span></span>
<span><span class="co">#&gt;   set    diversity</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> p1    0.000<span style="text-decoration: underline;">002</span>26</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> p2    0.000<span style="text-decoration: underline;">068</span>4</span></span></code></pre>
<p>Everything works! <strong>Now, how can we parallelize the computation
of diversity across all parameters of the grid?</strong></p>
<div class="section level2">
<h2 id="implicit-parallelization-via-future">1. Implicit parallelization via <em>future</em><a class="anchor" aria-label="anchor" href="#implicit-parallelization-via-future"></a>
</h2>
<p>The simplest way to parallelize <em>demografr</em> workflow is via
the R package <a href="https://cran.r-project.org/package=future" class="external-link"><em>future</em></a>.</p>
<p>The magic of <em>future</em> lies in its ability to set up
parallelized schemes of arbitrary topologies by automatic scheduling of
jobs across a given number of CPUs distributed even across several
remote compute servers.</p>
<p>Going into detail in setting up <em>future</em>-based parallelization
would be too far out of scope of this simple vignette (or
<em>demografr</em>’s documentation in general). Luckily, once
<em>future</em> parallelization is set up, it doesn’t matter whether the
computation is done by <em>demografr</em> or anything else, as the
<em>future</em> architecture is completely general.</p>
<p>In order to use <em>future</em> effectively, you should study its
documentation and tutorials (a good start would be the vignette <a href="https://cran.r-project.org/package=future" class="external-link">here</a>), but here is
a brief introduction focused on parallelizing a toy <em>demografr</em>
analysis set up above:</p>
<div class="section level3">
<h3 id="sequential-run">Sequential run<a class="anchor" aria-label="anchor" href="#sequential-run"></a>
</h3>
<p>By default, if we would run <code><a href="../reference/simulate_grid.html">simulate_grid()</a></code>, all
simulations would be run <em>sequentially</em>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_grid.html">simulate_grid</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">grid</span>, <span class="va">functions</span>, replicates <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                      sequence_length <span class="op">=</span> <span class="fl">10000</span>, recombination_rate <span class="op">=</span> <span class="fl">1e-8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 90 × 4</span></span></span>
<span><span class="co">#&gt;      rep Ne_p1 Ne_p2 diversity       </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1    10    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     1    10   100 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     1    10  <span style="text-decoration: underline;">1</span>000 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     1   100    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     1   100   100 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     1   100  <span style="text-decoration: underline;">1</span>000 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     1  <span style="text-decoration: underline;">1</span>000    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     1  <span style="text-decoration: underline;">1</span>000   100 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     1  <span style="text-decoration: underline;">1</span>000  <span style="text-decoration: underline;">1</span>000 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     2    10    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 80 more rows</span></span></span></code></pre>
<p><strong>The total runtime for the grid simulations was 0 hours 0
minutes 48 seconds parallelized across 10 CPUs.</strong></p>
</div>
<div class="section level3">
<h3 id="parallelization-across-cpus-of-one-machine">Parallelization across CPUs of one machine<a class="anchor" aria-label="anchor" href="#parallelization-across-cpus-of-one-machine"></a>
</h3>
<p>In order to distribute simulations across all (or some) available CPU
cores of your machine, you only need to put the following bit of R code
<em>before</em> your call to <code><a href="../reference/simulate_grid.html">simulate_grid()</a></code>. For instance,
on my personal laptop which has 10 CPUs, I can run the above grid
simulations using all available CPUs like this.</p>
<p>First we setup <em>future</em>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="co"># use 10 CPUs</span></span></code></pre></div>
<p>Then we can run the simulations <strong>without having to do anything
else!</strong> This last point is important: <em>demografr</em> can
automatically leverage whatever parallelization scheme you set up via
<em>future</em>’s function <code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan()</a></code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_grid.html">simulate_grid</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">grid</span>, <span class="va">functions</span>, replicates <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                      sequence_length <span class="op">=</span> <span class="fl">100000</span>, recombination_rate <span class="op">=</span> <span class="fl">1e-8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 90 × 4</span></span></span>
<span><span class="co">#&gt;      rep Ne_p1 Ne_p2 diversity       </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1    10    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     1    10   100 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     1    10  <span style="text-decoration: underline;">1</span>000 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     1   100    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     1   100   100 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     1   100  <span style="text-decoration: underline;">1</span>000 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     1  <span style="text-decoration: underline;">1</span>000    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     1  <span style="text-decoration: underline;">1</span>000   100 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     1  <span style="text-decoration: underline;">1</span>000  <span style="text-decoration: underline;">1</span>000 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     2    10    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 80 more rows</span></span></span></code></pre>
<p><strong>The total runtime for the grid simulations was 0 hours 0
minutes 22 seconds parallelized across 10 CPUs.</strong></p>
<p>Notice the speed up even for this trivial simulation pipeline!</p>
</div>
<div class="section level3">
<h3 id="parallelization-across-cpus-of-multiple-machines">Parallelization across CPUs of multiple machines<a class="anchor" aria-label="anchor" href="#parallelization-across-cpus-of-multiple-machines"></a>
</h3>
<p>If you read the documentation of the <em>future</em> package (which
you really <a href="https://cran.r-project.org/package=future" class="external-link">should</a>), you will
discover many more options for parallelization giving you near limitless
options for scheduling parallel simulations.</p>
<p>For instance, imagine you have access to remote machines
<code>server01</code>, <code>server02</code>, <code>server03</code>, all
with available R as well as <em>demografr</em> and <em>slendr</em> R
packages, with set up <em>slendr</em> environments. In other words, you
can start an R interpreter on each of these machines and eventually
call:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bodkan/demografr" class="external-link">demografr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bodkan/slendr" class="external-link">slendr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/slendr/man/init_env.html" class="external-link">init_env</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; The interface to all required Python modules has been activated.</span></span></code></pre>
<p>Then, you can distribute the <code><a href="../reference/simulate_grid.html">simulate_grid()</a></code> run (but
also <code><a href="../reference/simulate_abc.html">simulate_abc()</a></code>, of course!) simply by adjusting the
<code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan()</a></code> setup like this:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hostnames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"server01"</span>, <span class="st">"server02"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="va">hostnames</span><span class="op">)</span></span></code></pre></div>
<p>We won’t be running this example here in practice because the
“server01”, etc., obviously don’t exist, but hopefully you get the
idea.</p>
<p>In short, the <em>future</em> R package (and it’s support provided by
<em>demografr</em>) makes it very easy to set up arbitrary
parallelization schemes without doing additional work beyond setting up
the parallelization <code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="for-completeness">For completeness<a class="anchor" aria-label="anchor" href="#for-completeness"></a>
</h3>
<p>By default, if you don’t set up any <code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan()</a></code> at all, the
simulation runs of <em>demografr</em> will be run in a sequential
manner, because the default mode of operation for the <em>future</em> R
package is the following plan:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></code></pre></div>
<p>But this is just for completeness. It’s not something that makes much
sense to do in practice, perhaps beyond debugging parallelization
issues.</p>
</div>
</div>
<div class="section level2">
<h2 id="manual-parallelization">2. “Manual” parallelization<a class="anchor" aria-label="anchor" href="#manual-parallelization"></a>
</h2>
<p>In my personal experience, it can be a bit of a hassle to distribute
jobs across different machines, despite the conveniences of the
<em>future</em> R package. If you’re having such problems, I first
<em>highly</em> encourage you to <a href="https://cran.r-project.org/package=future" class="external-link">read</a> the basic
overview vignette and look up troubleshooting advice on Google.</p>
<p>Still, <em>demografr</em> provides rudimentary support for “manual”
paralelization across multiple machines (each of those machines
parallelizing on multiple CPUs), followed by merging simulation runs
into a single data set.</p>
<p>To demonstrate this, let’s pretend we ran five simulation grid runs
across two different computers like this (we were originally interested
in distributing 10 replicates, so we’ll run two times five replicates
individually):</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">run1_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".rds"</span><span class="op">)</span></span>
<span><span class="va">run2_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># on machine #1</span></span>
<span><span class="fu"><a href="../reference/simulate_grid.html">simulate_grid</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">grid</span>, <span class="va">functions</span>, replicates <span class="op">=</span> <span class="fl">5</span>,</span>
<span>              sequence_length <span class="op">=</span> <span class="fl">100000</span>, recombination_rate <span class="op">=</span> <span class="fl">1e-8</span>, file <span class="op">=</span> <span class="va">run1_file</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># on machine #2</span></span>
<span><span class="fu"><a href="../reference/simulate_grid.html">simulate_grid</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">grid</span>, <span class="va">functions</span>, replicates <span class="op">=</span> <span class="fl">5</span>,</span>
<span>              sequence_length <span class="op">=</span> <span class="fl">100000</span>, recombination_rate <span class="op">=</span> <span class="fl">1e-8</span>, file <span class="op">=</span> <span class="va">run2_file</span><span class="op">)</span></span></code></pre></div>
<p>Then, once we collected the individual <code>.rds</code> files on a
single computer from the remote machines (perhaps using something like
the <code>scp</code> unix command), we can use another
<em>demografr</em> function <code><a href="../reference/combine_data.html">combine_data()</a></code> to merge all
individual runs into a single result:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/combine_data.html">combine_data</a></span><span class="op">(</span><span class="va">run1_file</span>, <span class="va">run2_file</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 90 × 4</span></span></span>
<span><span class="co">#&gt;      rep Ne_p1 Ne_p2 diversity       </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1    10    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     1    10   100 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     1    10  <span style="text-decoration: underline;">1</span>000 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     1   100    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     1   100   100 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     1   100  <span style="text-decoration: underline;">1</span>000 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     1  <span style="text-decoration: underline;">1</span>000    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     1  <span style="text-decoration: underline;">1</span>000   100 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     1  <span style="text-decoration: underline;">1</span>000  <span style="text-decoration: underline;">1</span>000 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     2    10    10 <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 80 more rows</span></span></span></code></pre>
<p>For each combination of parameters we ran five replicates across “two
different machines”, totaling 9 x 5 x 2 = 90 simulations, so we should
get the same number of rows in the merged data frame:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 90</span></span></code></pre>
<p>One thing to note that <code><a href="../reference/simulate_grid.html">simulate_grid()</a></code> as well as
<code><a href="../reference/simulate_abc.html">simulate_abc()</a></code> really do save standard RDS files as one
normally would using function <code><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS()</a></code> (in fact, they use
this function internally). An additional benefit of using this approach
combined with <code><a href="../reference/combine_data.html">combine_data()</a></code> is that these functions
provide additional sanity checks making sure that the simulation data
sets being merged are consistent (coming from the same model function,
with the same priors or summary statistics, etc.).</p>
<p>For completeness, <code><a href="../reference/combine_data.html">combine_data()</a></code> not only accepts file
paths as individual function arguments but also file names as vectors,
as well as individual data frame objects generated by
<code><a href="../reference/simulate_grid.html">simulate_grid()</a></code> and <code><a href="../reference/simulate_abc.html">simulate_abc()</a></code>. In other
words, the following approaches will all result in the same combined
data set:</p>
<p><strong>Merging data from serialized data files:</strong></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/combine_data.html">combine_data</a></span><span class="op">(</span><span class="va">run1_file</span>, <span class="va">run2_file</span><span class="op">)</span></span>
<span><span class="va">combined2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/combine_data.html">combine_data</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">run1_file</span>, <span class="va">run2_file</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>Merging data objects themselves directly:</strong></p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">run1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_grid.html">simulate_grid</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">grid</span>, <span class="va">functions</span>, replicates <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                      sequence_length <span class="op">=</span> <span class="fl">100000</span>, recombination_rate <span class="op">=</span> <span class="fl">1e-8</span><span class="op">)</span></span>
<span><span class="va">run2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_grid.html">simulate_grid</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">grid</span>, <span class="va">functions</span>, replicates <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                      sequence_length <span class="op">=</span> <span class="fl">100000</span>, recombination_rate <span class="op">=</span> <span class="fl">1e-8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/combine_data.html">combine_data</a></span><span class="op">(</span><span class="va">run1</span>, <span class="va">run2</span><span class="op">)</span></span>
<span><span class="va">combined4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/combine_data.html">combine_data</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">run1</span>, <span class="va">run2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>All <code><a href="../reference/combine_data.html">combine_data()</a></code> approaches give the same
result:</strong></p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">combined1</span>, <span class="va">combined2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] TRUE</span></span></code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">combined3</span>, <span class="va">combined4</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] TRUE</span></span></code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">combined2</span>, <span class="va">combined3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] TRUE</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Martin Petr.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
