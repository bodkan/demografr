<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Detailed discussion on priors • demografr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Detailed discussion on priors">
<meta property="og:description" content="demografr">
<meta property="og:image" content="https://bodkan.github.io/demografr/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">demografr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question-circle"></span>
     
    Reference
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-book"></span>
     
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/vignette-01-basic-abc.html">A basic ABC analysis</a>
    </li>
    <li>
      <a href="../articles/vignette-02-scaffold-models.html">Defining scaffold models</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/dr_bodkan" class="external-link">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Detailed discussion on priors</h1>
            
      
      
      <div class="hidden name"><code>vignette-03-custom-priors.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In a <a href="vignette-02-scaffold-models.html">previous
vignette</a>, we looked at how <em>demografr</em> allows a complete
customization of what a “scaffold model” can look like and that
basically any functions which returns a compiled slendr model can serve
as such a scaffold, with its function arguments representing parameters
which need to be assigned priors.</p>
<p>In this vignette, we will take things even further, showing that in
addition to standard prior sampling expression using familiar functions
such as <code>runif</code> or <code>rnorm</code>, any function which
follows certain constraints can serve as a prior.</p>
<p>The example we will use here will focus on trying to infer
phylogenetic relationships between populations, using prior
distributions on trees themselves.</p>
<p>Again, let’s begin by loading a couple of libraries and setting up
parallelization for inference:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># R packages for working with phylogenetic trees</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://ape-package.ird.fr/" class="external-link">ape</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/KlausVigo/phangorn" class="external-link">phangorn</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bodkan/slendr" class="external-link">slendr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">demografr</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># my Mac has 10 cores, feel free to adjust this</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fu"><a href="https://parallelly.futureverse.org/reference/availableCores.html" class="external-link">availableCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We then load summary statistics computed from “sequenced” real
data:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diversity_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/01_diversity.tsv"</span>, package <span class="op">=</span> <span class="st">"demografr"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">divergence_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/01_divergence.tsv"</span>, package <span class="op">=</span> <span class="st">"demografr"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>diversity <span class="op">=</span> <span class="va">diversity_df</span>, divergence <span class="op">=</span> <span class="va">divergence_df</span><span class="op">)</span></span></code></pre></div>
<p>And we also define corresponding tree-sequence-based summary
statistics using functions that operate on simulated tree-sequence
objects:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">compute_diversity</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/ts_samples.html" class="external-link">ts_samples</a></span><span class="op">(</span><span class="va">ts</span>, split <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/ts_diversity.html" class="external-link">ts_diversity</a></span><span class="op">(</span><span class="va">ts</span>, sample_sets <span class="op">=</span> <span class="va">samples</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"pi_"</span>, <span class="va">set</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">stat</span>, value <span class="op">=</span> <span class="va">diversity</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">compute_divergence</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/ts_samples.html" class="external-link">ts_samples</a></span><span class="op">(</span><span class="va">ts</span>, split <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/ts_divergence.html" class="external-link">ts_divergence</a></span><span class="op">(</span><span class="va">ts</span>, sample_sets <span class="op">=</span> <span class="va">samples</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"d_%s_%s"</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">stat</span>, value <span class="op">=</span> <span class="va">divergence</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">functions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>diversity <span class="op">=</span> <span class="va">compute_diversity</span>, divergence <span class="op">=</span> <span class="va">compute_divergence</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="how-do-priors-work-in-demografr">How do priors work in <em>demografr</em>?<a class="anchor" aria-label="anchor" href="#how-do-priors-work-in-demografr"></a>
</h3>
<p>Our ABC model will use standard priors on <span class="math inline">\(N_e\)</span> and divergence times. As in our other
vignettes, we will use uniform distributions to do this.</p>
<p>Recall a function <code>runif</code> which is used in the following
way to sample a single number:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, min <span class="op">=</span> <span class="fl">1</span>, max <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 910.3563</span></span></code></pre></div>
<p>To save us a bit of typing and to make prior definitions a bit more
consise, <em>demografr</em> uses the following syntax to define model
parameters:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prior</span> <span class="op">&lt;-</span> <span class="va">Ne_popXYZ</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
<p>This formula-based syntax, which some of you will be familiar from
fitting linear models
(i.e. <code>lm(response ~ pred1 + pred2 + pred3)</code>) does not
actually perform any sampling. It merely represents a readable way to
encode probabilistic sampling statements. To demonstrate this, typing
the prior in the R console simply returns the statement:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prior</span></span>
<span><span class="co">#&gt; Ne_popXYZ ~ runif(1, 1000)</span></span></code></pre></div>
<p>You might also notice that the right-hand side of the prior sampling
expression above <code>Ne_popXYZ ~ runif(0, 1000)</code> does not
represent a valid statement:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in runif(1, 1000): NAs produced</span></span>
<span><span class="co">#&gt; [1] NaN</span></span></code></pre></div>
<p>That is not a problem, because sampling from priors (which
<em>demografr</em> performs internally during ABC simulations) is taken
care of automatically, converting the above function call into proper
sampling statement:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span> <span class="va">Ne_popXYZ</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1000</span><span class="op">)</span> <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/sample_prior.html">sample_prior</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; $variable</span></span>
<span><span class="co">#&gt; [1] "Ne_popXYZ"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $value</span></span>
<span><span class="co">#&gt; [1] 902.9741</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="how-to-define-custom-priors">How to define custom priors?<a class="anchor" aria-label="anchor" href="#how-to-define-custom-priors"></a>
</h3>
<p>Now that we have gone through how priors work using standard R
functions like <code>runif</code>, how can we define our own prior
distributions?</p>
<p>In short, <em>any</em> function that returns a single value (of
whatever type! see below) can serve as a prior. The only requirement is
that the first argument of the function must be called <code>n</code>.
This is purely for formal reasons and to make the prior sampling
interface of <em>demografr</em> in line with the interface of all
functions of the <code>r[unif/norm/pois/exp/...]</code> type that we
know from R (i.e. the full interface of the function <code>rnorm</code>
is <code>rnorm(n, mean = 0, sd = 1)</code>). Except for the first
argument <code>n</code>, you can use whatever function arguments you
want.</p>
<p>Let’s consider a uniform prior over tree genealogies with <span class="math inline">\(n\)</span> tips by defining a simple R function
like this:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">topologies</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://klausvigo.github.io/phangorn/reference/allTrees.html" class="external-link">allTrees</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">4</span>, rooted <span class="op">=</span> <span class="cn">TRUE</span>, tip.label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"popA"</span>, <span class="st">"popB"</span>, <span class="st">"popC"</span>, <span class="st">"popD"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sample_topology</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">topologies</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">topologies</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Note that as explained in the paragraph above, the function has a
formal argument <code>n</code> but does not actually use it. The
argument which <em>is</em> used internally is <code>ntips</code>,
describing the number of leaves of the tree to be generated by the
function <code><a href="https://rdrr.io/pkg/ape/man/rtree.html" class="external-link">rtopology()</a></code> from the package <em>ape</em>.</p>
<p>When we call it manually, we get a tree in the standard phylogetic
format of the R package <a href="https://cran.r-project.org/package=ape" class="external-link">ape</a>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tree</span> <span class="op">&lt;-</span> <span class="fu">sample_topology</span><span class="op">(</span>, <span class="va">topologies</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="va">topologies</span><span class="op">[[</span><span class="va">.</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">tree</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Phylogenetic tree with 4 tips and 3 internal nodes.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Tip labels:</span></span>
<span><span class="co">#&gt;   popA, popB, popC, popD</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Rooted; no branch lengths.</span></span></code></pre></div>
<p><img src="vignette-03-custom-priors_files/figure-html/ape_tree-1.png" width="480" style="display: block; margin: auto;"></p>
<p>Using our tree sampling function we can now define a uniform prior
over all phylogenetic trees of a given number of leaves:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prior</span> <span class="op">&lt;-</span> <span class="va">topology</span> <span class="op">~</span> <span class="fu">sample_topology</span><span class="op">(</span><span class="va">topologies</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sample_prior.html">sample_prior</a></span><span class="op">(</span><span class="va">prior</span><span class="op">)</span></span>
<span><span class="co">#&gt; $variable</span></span>
<span><span class="co">#&gt; [1] "topology"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $value</span></span>
<span><span class="co">#&gt; [1] 2</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="defining-a-model">Defining a model<a class="anchor" aria-label="anchor" href="#defining-a-model"></a>
</h3>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">topologies</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/tree_model.html">tree_model</a></span><span class="op">(</span><span class="va">topologies</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, N <span class="op">=</span> <span class="fl">1000</span>, time_span <span class="op">=</span> <span class="fl">10000</span>, generation_time <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Hopefully, it should be clear how much more flexibility this kind of
set up gives us in defining scaffold models for an ABC analysis. Of
course, running this function with a given set of parameters compiles a
standard <em>slendr</em> model, no surprises there. This makes it easy
to verify that the generating function is set up correctly, like we do
in the following code chunk by providing arbitrary values of our
parameters:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_model</span> <span class="op">&lt;-</span> <span class="fu">model</span><span class="op">(</span><span class="fl">1</span>, <span class="va">topologies</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/slendr/man/plot_model.html" class="external-link">plot_model</a></span><span class="op">(</span><span class="va">test_model</span><span class="op">)</span></span></code></pre></div>
<p><img src="vignette-03-custom-priors_files/figure-html/slendr_model3-1.png" width="480" style="display: block; margin: auto;"></p>
<p>How do we use this kind of flexible scaffold model for ABC inference?
First, we need to specify the priors. This is very easy: the only thing
we need to do is <strong>specify prior parameter sampling statements
with variable names matching the function arguments!</strong></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="va">i</span> <span class="op">~</span> <span class="fu">sample_topology</span><span class="op">(</span><span class="va">topologies</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note that the visualization shows the same model. This is not a
surprise, because what the automated functions <code><a href="../reference/tree_model.html">tree_model()</a></code>
does internally is run exactly the same sequence of commands we
specified manually above.</p>
<p>For such generating function-based models, it is even more worth to
validate the ABC setup to catch issues as early as possible:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/validate_abc.html">validate_abc</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">priors</span>, <span class="va">functions</span>, <span class="va">observed</span>, topologies <span class="op">=</span> <span class="va">topologies</span><span class="op">)</span></span>
<span><span class="co">#&gt; ============================================================</span></span>
<span><span class="co">#&gt; A generating function was provided as a scaffold</span></span>
<span><span class="co">#&gt; ============================================================</span></span>
<span><span class="co">#&gt; Checking the presence of required function arguments...  ✓</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Testing sampling of each prior parameter:</span></span>
<span><span class="co">#&gt;   * i ✓</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Running the model function with sampled prior values... ✓</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Simulating a tree sequence from the constructed model... ✓</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Computing user-defined summary functions:</span></span>
<span><span class="co">#&gt;   * diversity ✓</span></span>
<span><span class="co">#&gt;   * divergence ✓</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Checking the format of simulated summary statistics:</span></span>
<span><span class="co">#&gt;   * diversity ✓</span></span>
<span><span class="co">#&gt;   * divergence ✓</span></span>
<span><span class="co">#&gt; ============================================================</span></span>
<span><span class="co">#&gt; No issues have been found in the ABC setup!</span></span></code></pre></div>
<p>Having convinced ourselves that the ABC model components are
correctly configured, we would proceed with inference (again, we’re not
going to run the full ABC pipeline here because it would take a lot of
time to get useful posteriors):</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># first simulate data</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_abc.html">simulate_abc</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">priors</span>, <span class="va">functions</span>, <span class="va">observed</span>, iterations <span class="op">=</span> <span class="fl">1000</span>, sequence_length <span class="op">=</span> <span class="fl">1e6</span>, recombination_rate <span class="op">=</span> <span class="fl">1e-8</span>, topologies <span class="op">=</span> <span class="va">topologies</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># then perform ABC inference</span></span>
<span><span class="va">abc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/perform_abc.html">perform_abc</a></span><span class="op">(</span><span class="va">data</span>, tolerance <span class="op">=</span> <span class="fl">0.05</span>, method <span class="op">=</span> <span class="st">"neuralnet"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Martin Petr.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
