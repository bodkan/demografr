<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Defining scaffold models • demografr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Defining scaffold models">
<meta property="og:description" content="demografr">
<meta property="og:image" content="https://bodkan.github.io/demografr/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">demografr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question-circle"></span>
     
    Reference
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-book"></span>
     
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/vignette-01-basic-abc.html">A basic ABC analysis</a>
    </li>
    <li>
      <a href="../articles/vignette-02-scaffold-models.html">Defining scaffold models</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/dr_bodkan" class="external-link">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Defining scaffold models</h1>
            
      
      
      <div class="hidden name"><code>vignette-02-scaffold-models.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Let’s return to our <a href="vignette-01-basic-abc.html">introductory
example</a>. The “scaffold” model we defined in that vignette was
created using a built-in function <code><a href="../reference/tree_model.html">tree_model()</a></code>, which
accepts a phylogenetic tree as input and converts it into an appropriate
<em>slendr</em> demographic model which <em>demografr</em> later uses as
a scaffold for ABC inference.</p>
<p>We begin by loading all required packages, and setting up
parallelization for our inference using the package <em>future</em>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bodkan/slendr" class="external-link">slendr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">demografr</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># my Mac has 10 cores, feel free to adjust this</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fu"><a href="https://parallelly.futureverse.org/reference/availableCores.html" class="external-link">availableCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Load observed summary statistics computed from “sequenced” real
data:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diversity_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/01_diversity.tsv"</span>, package <span class="op">=</span> <span class="st">"demografr"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">divergence_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/01_divergence.tsv"</span>, package <span class="op">=</span> <span class="st">"demografr"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>diversity <span class="op">=</span> <span class="va">diversity_df</span>, divergence <span class="op">=</span> <span class="va">divergence_df</span><span class="op">)</span></span></code></pre></div>
<p>Define tree-sequence-based summary functions:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">compute_diversity</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/ts_samples.html" class="external-link">ts_samples</a></span><span class="op">(</span><span class="va">ts</span>, split <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/ts_diversity.html" class="external-link">ts_diversity</a></span><span class="op">(</span><span class="va">ts</span>, sample_sets <span class="op">=</span> <span class="va">samples</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"pi_"</span>, <span class="va">set</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">stat</span>, value <span class="op">=</span> <span class="va">diversity</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">compute_divergence</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/ts_samples.html" class="external-link">ts_samples</a></span><span class="op">(</span><span class="va">ts</span>, split <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/ts_divergence.html" class="external-link">ts_divergence</a></span><span class="op">(</span><span class="va">ts</span>, sample_sets <span class="op">=</span> <span class="va">samples</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"d_%s_%s"</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">stat</span>, value <span class="op">=</span> <span class="va">divergence</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">functions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>diversity <span class="op">=</span> <span class="va">compute_diversity</span>, divergence <span class="op">=</span> <span class="va">compute_divergence</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="scaffold-model-from-a-tree">Scaffold model from a tree<a class="anchor" aria-label="anchor" href="#scaffold-model-from-a-tree"></a>
</h3>
<p>To recap, this is how we built that model from a phylogenetic
tree:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tree_model.html">tree_model</a></span><span class="op">(</span>tree <span class="op">=</span> <span class="st">"(popA,(popB,(popC,popD)));"</span>, time_span <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/slendr/man/plot_model.html" class="external-link">plot_model</a></span><span class="op">(</span><span class="va">model1</span><span class="op">)</span></span></code></pre></div>
<p><img src="vignette-02-scaffold-models_files/figure-html/slendr_model1-1.png" width="480" style="display: block; margin: auto;"></p>
<p>After specifying the priors we can plug this model into the ABC
inference pipeline:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="va">Ne_popA</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10000</span><span class="op">)</span>,</span>
<span>  <span class="va">Ne_popB</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10000</span><span class="op">)</span>,</span>
<span>  <span class="va">Ne_popC</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10000</span><span class="op">)</span>,</span>
<span>  <span class="va">Ne_popD</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10000</span><span class="op">)</span>,</span>
<span></span>
<span>  <span class="va">Tsplit_popA_popB</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3000</span><span class="op">)</span>,</span>
<span>  <span class="va">Tsplit_popB_popC</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">3000</span>, <span class="fl">6000</span><span class="op">)</span>,</span>
<span>  <span class="va">Tsplit_popC_popD</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">6000</span>, <span class="fl">9000</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>From the previous vignette we already know this ABC model setup is
valid, but it’s always worth checking again:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/validate_abc.html">validate_abc</a></span><span class="op">(</span><span class="va">model1</span>, <span class="va">priors</span>, <span class="va">functions</span>, <span class="va">observed</span><span class="op">)</span></span>
<span><span class="co">#&gt; ============================================================</span></span>
<span><span class="co">#&gt; Standard slendr model provided as a scaffold</span></span>
<span><span class="co">#&gt; ============================================================</span></span>
<span><span class="co">#&gt; Checking the correct syntax of population names...  ✓</span></span>
<span><span class="co">#&gt; Checking the correctness of prior parameter names...  ✓</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Testing sampling of each prior parameter:</span></span>
<span><span class="co">#&gt;   * Ne_popA ✓</span></span>
<span><span class="co">#&gt;   * Ne_popB ✓</span></span>
<span><span class="co">#&gt;   * Ne_popC ✓</span></span>
<span><span class="co">#&gt;   * Ne_popD ✓</span></span>
<span><span class="co">#&gt;   * Tsplit_popA_popB ✓</span></span>
<span><span class="co">#&gt;   * Tsplit_popB_popC ✓</span></span>
<span><span class="co">#&gt;   * Tsplit_popC_popD ✓</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Modifying the scaffold model with sampled prior values... ✓</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Simulating a tree sequence from the constructed model... ✓</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Computing user-defined summary functions:</span></span>
<span><span class="co">#&gt;   * diversity ✓</span></span>
<span><span class="co">#&gt;   * divergence ✓</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Checking the format of simulated summary statistics:</span></span>
<span><span class="co">#&gt;   * diversity ✓</span></span>
<span><span class="co">#&gt;   * divergence ✓</span></span>
<span><span class="co">#&gt; ============================================================</span></span>
<span><span class="co">#&gt; No issues have been found in the ABC setup!</span></span></code></pre></div>
<p>In order to save computational time, we won’t simulate the full ABC
run. That said, for completeness, here are two commands we would usually
run once the ABC setup is successfully validated. We would first
simulate data for ABC inference:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_abc.html">simulate_abc</a></span><span class="op">(</span><span class="va">model1</span>, <span class="va">priors</span>, <span class="va">functions</span>, <span class="va">observed</span>, iterations <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>                    sequence_length <span class="op">=</span> <span class="fl">1e6</span>, recombination_rate <span class="op">=</span> <span class="fl">1e-8</span><span class="op">)</span></span></code></pre></div>
<p>Then we would plug the simulations into the inference function
<code><a href="../reference/perform_abc.html">perform_abc()</a></code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">abc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/perform_abc.html">perform_abc</a></span><span class="op">(</span><span class="va">data</span>, tolerance <span class="op">=</span> <span class="fl">0.05</span>, method <span class="op">=</span> <span class="st">"neuralnet"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="scaffold-model-from-a-slendr-model">Scaffold model from a <em>slendr</em> model<a class="anchor" aria-label="anchor" href="#scaffold-model-from-a-slendr-model"></a>
</h3>
<p>An alternative way to define a <em>demografr</em> scaffold model is
to write a standard <em>slendr</em> model the usual way, manually:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">popA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/population.html" class="external-link">population</a></span><span class="op">(</span><span class="st">"popA"</span>, time <span class="op">=</span> <span class="fl">1</span>, N <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">popB</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/population.html" class="external-link">population</a></span><span class="op">(</span><span class="st">"popB"</span>, time <span class="op">=</span> <span class="fl">2500</span>, N <span class="op">=</span> <span class="fl">1</span>, parent <span class="op">=</span> <span class="va">popA</span><span class="op">)</span></span>
<span><span class="va">popC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/population.html" class="external-link">population</a></span><span class="op">(</span><span class="st">"popC"</span>, time <span class="op">=</span> <span class="fl">5000</span>, N <span class="op">=</span> <span class="fl">1</span>, parent <span class="op">=</span> <span class="va">popB</span><span class="op">)</span></span>
<span><span class="va">popD</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/population.html" class="external-link">population</a></span><span class="op">(</span><span class="st">"popD"</span>, time <span class="op">=</span> <span class="fl">7500</span>, N <span class="op">=</span> <span class="fl">1</span>, parent <span class="op">=</span> <span class="va">popC</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/compile_model.html" class="external-link">compile_model</a></span><span class="op">(</span></span>
<span>  populations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">popA</span>, <span class="va">popB</span>, <span class="va">popC</span>, <span class="va">popD</span><span class="op">)</span>,</span>
<span>  simulation_length <span class="op">=</span> <span class="fl">10000</span>, generation_time <span class="op">=</span> <span class="fl">1</span>, serialize <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/slendr/man/plot_model.html" class="external-link">plot_model</a></span><span class="op">(</span><span class="va">model2</span><span class="op">)</span></span></code></pre></div>
<p><img src="vignette-02-scaffold-models_files/figure-html/slendr_model2-1.png" width="480" style="display: block; margin: auto;"></p>
<p>Note that the visualization shows the same model as the one we
defined with an input tree above. This is not a surprise, because what
the automated functions <code><a href="../reference/tree_model.html">tree_model()</a></code> does internally is run
exactly the same sequence of commands we specified manually above.</p>
<p>Why would you use this option instead of inputting a phylogenetic
tree? For one thing, this method gives you a finer control over which
population should exactly split from which, which gets a little tricky
with the Newick tree input method via <code><a href="../reference/tree_model.html">tree_model()</a></code> or
<code><a href="../reference/tree_populations.html">tree_populations()</a></code>. Additionally, it makes it possible to
fix some model parameters (such as <span class="math inline">\(N_e\)</span> or divergence times) to different
values, skipping the need to specify prior distributions for them simply
by leaving them out of the prior definition list.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/validate_abc.html">validate_abc</a></span><span class="op">(</span><span class="va">model2</span>, <span class="va">priors</span>, <span class="va">functions</span>, <span class="va">observed</span><span class="op">)</span></span>
<span><span class="co">#&gt; ============================================================</span></span>
<span><span class="co">#&gt; Standard slendr model provided as a scaffold</span></span>
<span><span class="co">#&gt; ============================================================</span></span>
<span><span class="co">#&gt; Checking the correct syntax of population names...  ✓</span></span>
<span><span class="co">#&gt; Checking the correctness of prior parameter names...  ✓</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Testing sampling of each prior parameter:</span></span>
<span><span class="co">#&gt;   * Ne_popA ✓</span></span>
<span><span class="co">#&gt;   * Ne_popB ✓</span></span>
<span><span class="co">#&gt;   * Ne_popC ✓</span></span>
<span><span class="co">#&gt;   * Ne_popD ✓</span></span>
<span><span class="co">#&gt;   * Tsplit_popA_popB ✓</span></span>
<span><span class="co">#&gt;   * Tsplit_popB_popC ✓</span></span>
<span><span class="co">#&gt;   * Tsplit_popC_popD ✓</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Modifying the scaffold model with sampled prior values... ✓</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Simulating a tree sequence from the constructed model... ✓</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Computing user-defined summary functions:</span></span>
<span><span class="co">#&gt;   * diversity ✓</span></span>
<span><span class="co">#&gt;   * divergence ✓</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Checking the format of simulated summary statistics:</span></span>
<span><span class="co">#&gt;   * diversity ✓</span></span>
<span><span class="co">#&gt;   * divergence ✓</span></span>
<span><span class="co">#&gt; ============================================================</span></span>
<span><span class="co">#&gt; No issues have been found in the ABC setup!</span></span></code></pre></div>
<p>Again, we will skip the simulations and inference, which we would
normally perform with something like this (skipping this step here to
save computational time):</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># first simulate data</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_abc.html">simulate_abc</a></span><span class="op">(</span><span class="va">model2</span>, <span class="va">priors</span>, <span class="va">functions</span>, <span class="va">observed</span>, iterations <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>                    sequence_length <span class="op">=</span> <span class="fl">1e6</span>, recombination_rate <span class="op">=</span> <span class="fl">1e-8</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># then perform ABC inference</span></span>
<span><span class="va">abc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/perform_abc.html">perform_abc</a></span><span class="op">(</span><span class="va">data</span>, tolerance <span class="op">=</span> <span class="fl">0.05</span>, method <span class="op">=</span> <span class="st">"neuralnet"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="function-based-model-definition">Function-based model definition<a class="anchor" aria-label="anchor" href="#function-based-model-definition"></a>
</h3>
<p>A yet another way to define a <em>demografr</em> scaffold model which
allows even more flexibility in terms of supporting complex
parametrizations is to provide an entire self-contained function:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">size_A</span>, <span class="va">size_B</span>, <span class="va">size_C</span>, <span class="va">size_D</span>, <span class="va">split_AB</span>, <span class="va">split_BC</span>, <span class="va">split_CD</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">popA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/population.html" class="external-link">population</a></span><span class="op">(</span><span class="st">"popA"</span>, time <span class="op">=</span> <span class="fl">1</span>,        N <span class="op">=</span> <span class="va">size_A</span><span class="op">)</span></span>
<span>  <span class="va">popB</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/population.html" class="external-link">population</a></span><span class="op">(</span><span class="st">"popB"</span>, time <span class="op">=</span> <span class="va">split_AB</span>, N <span class="op">=</span> <span class="va">size_B</span>, parent <span class="op">=</span> <span class="va">popA</span><span class="op">)</span></span>
<span>  <span class="va">popC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/population.html" class="external-link">population</a></span><span class="op">(</span><span class="st">"popC"</span>, time <span class="op">=</span> <span class="va">split_BC</span>, N <span class="op">=</span> <span class="va">size_C</span>, parent <span class="op">=</span> <span class="va">popB</span><span class="op">)</span></span>
<span>  <span class="va">popD</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/population.html" class="external-link">population</a></span><span class="op">(</span><span class="st">"popD"</span>, time <span class="op">=</span> <span class="va">split_CD</span>, N <span class="op">=</span> <span class="va">size_D</span>, parent <span class="op">=</span> <span class="va">popC</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/slendr/man/compile_model.html" class="external-link">compile_model</a></span><span class="op">(</span></span>
<span>    populations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">popA</span>, <span class="va">popB</span>, <span class="va">popC</span>, <span class="va">popD</span><span class="op">)</span>,</span>
<span>    simulation_length <span class="op">=</span> <span class="fl">10000</span>, generation_time <span class="op">=</span> <span class="fl">1</span>, serialize <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Hopefully, it should be clear how much more flexibility this kind of
set up gives us in defining scaffold models for an ABC analysis. Of
course, running this function with a given set of parameters compiles a
standard <em>slendr</em> model, no surprises there. This makes it easy
to verify that the generating function is set up correctly, like we do
in the following code chunk by providing arbitrary values of our
parameters:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_model</span> <span class="op">&lt;-</span> <span class="fu">custom_model</span><span class="op">(</span></span>
<span>  size_A <span class="op">=</span> <span class="fl">1123</span>, size_B <span class="op">=</span> <span class="fl">4321</span>, size_C <span class="op">=</span> <span class="fl">42</span>, size_D <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>  split_AB <span class="op">=</span> <span class="fl">500</span>, split_BC <span class="op">=</span> <span class="fl">5000</span>, split_CD <span class="op">=</span> <span class="fl">7000</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/slendr/man/plot_model.html" class="external-link">plot_model</a></span><span class="op">(</span><span class="va">test_model</span><span class="op">)</span></span></code></pre></div>
<p><img src="vignette-02-scaffold-models_files/figure-html/slendr_model3-1.png" width="480" style="display: block; margin: auto;"></p>
<p>How do we use this kind of flexible scaffold model for ABC inference?
First, we need to specify the priors. This is very easy: the only thing
we need to do is <strong>specify prior parameter sampling statements
with variable names matching the function arguments!</strong></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="va">size_A</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10000</span><span class="op">)</span>,</span>
<span>  <span class="va">size_B</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10000</span><span class="op">)</span>,</span>
<span>  <span class="va">size_C</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10000</span><span class="op">)</span>,</span>
<span>  <span class="va">size_D</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10000</span><span class="op">)</span>,</span>
<span></span>
<span>  <span class="va">split_AB</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3000</span><span class="op">)</span>,</span>
<span>  <span class="va">split_BC</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">3000</span>, <span class="fl">6000</span><span class="op">)</span>,</span>
<span>  <span class="va">split_CD</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">6000</span>, <span class="fl">9000</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note that the visualization shows the same model. This is not a
surprise, because what the automated functions <code><a href="../reference/tree_model.html">tree_model()</a></code>
does internally is run exactly the same sequence of commands we
specified manually above.</p>
<p>For such generating function-based models, it is even more worth to
validate the ABC setup to catch issues as early as possible:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/validate_abc.html">validate_abc</a></span><span class="op">(</span><span class="va">custom_model</span>, <span class="va">custom_priors</span>, <span class="va">functions</span>, <span class="va">observed</span><span class="op">)</span></span>
<span><span class="co">#&gt; ============================================================</span></span>
<span><span class="co">#&gt; A generating function was provided as a scaffold</span></span>
<span><span class="co">#&gt; ============================================================</span></span>
<span><span class="co">#&gt; Checking the presence of required function arguments...  ✓</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Testing sampling of each prior parameter:</span></span>
<span><span class="co">#&gt;   * size_A ✓</span></span>
<span><span class="co">#&gt;   * size_B ✓</span></span>
<span><span class="co">#&gt;   * size_C ✓</span></span>
<span><span class="co">#&gt;   * size_D ✓</span></span>
<span><span class="co">#&gt;   * split_AB ✓</span></span>
<span><span class="co">#&gt;   * split_BC ✓</span></span>
<span><span class="co">#&gt;   * split_CD ✓</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Running the model function with sampled prior values... ✓</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Simulating a tree sequence from the constructed model... ✓</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Computing user-defined summary functions:</span></span>
<span><span class="co">#&gt;   * diversity ✓</span></span>
<span><span class="co">#&gt;   * divergence ✓</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Checking the format of simulated summary statistics:</span></span>
<span><span class="co">#&gt;   * diversity ✓</span></span>
<span><span class="co">#&gt;   * divergence ✓</span></span>
<span><span class="co">#&gt; ============================================================</span></span>
<span><span class="co">#&gt; No issues have been found in the ABC setup!</span></span></code></pre></div>
<p>Having convinced ourselves that the ABC model components are
correctly configured, we would proceed with inference (again, we’re not
going to run the full ABC pipeline here because it would take a lot of
time to get useful posteriors):</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># first simulate data</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_abc.html">simulate_abc</a></span><span class="op">(</span><span class="va">custom_model</span>, <span class="va">custom_priors</span>, <span class="va">functions</span>, <span class="va">observed</span>, iterations <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>                     sequence_length <span class="op">=</span> <span class="fl">1e6</span>, recombination_rate <span class="op">=</span> <span class="fl">1e-8</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># then perform ABC inference</span></span>
<span><span class="va">abc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/perform_abc.html">perform_abc</a></span><span class="op">(</span><span class="va">data</span>, tolerance <span class="op">=</span> <span class="fl">0.05</span>, method <span class="op">=</span> <span class="st">"neuralnet"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Martin Petr.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
